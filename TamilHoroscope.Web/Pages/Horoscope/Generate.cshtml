@page
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@attribute [Authorize]
@inject TamilHoroscope.Web.Services.Interfaces.ISubscriptionService SubscriptionService
@inject TamilHoroscope.Web.Services.Interfaces.IWalletService WalletService
@inject TamilHoroscope.Web.Services.Interfaces.IConfigService ConfigService
@model TamilHoroscope.Web.Pages.Horoscope.GenerateModel
@{
    ViewData["Title"] = "Generate Horoscope";
    var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
    var isInTrial = await SubscriptionService.IsUserInTrialAsync(userId);
    var balance = await WalletService.GetBalanceAsync(userId);
    var perDayCost = await ConfigService.GetPerDayCostAsync();
}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-stars"></i> Generate Horoscope</h4>
            </div>
            <div class="card-body">
                @if (isInTrial)
                {
                    <div class="alert alert-info">
                        <i class="bi bi-gift"></i> <strong>Trial Period Active</strong>
                        <p class="mb-0">You're in trial period. Limited features available (no Navamsa chart, basic Dasa only). No charges will be applied.</p>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-wallet2"></i> <strong>Paid Service</strong>
                        <p class="mb-0">First horoscope generation of the day costs ₹@perDayCost.ToString("F2"). Current balance: ₹@balance.ToString("F2")</p>
                    </div>
                }

                <form method="post" id="horoscopeForm">
                    @Html.AntiForgeryToken()
                    
                    <!-- Hidden fields for request verification -->
                    <input type="hidden" asp-for="RequestToken" id="requestToken" />
                    <input type="hidden" asp-for="RequestTimestamp" id="requestTimestamp" />
                    <input type="hidden" asp-for="BirthDetailsChecksum" id="birthDetailsChecksum" />
                    
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                    <h5 class="mt-3">Personal Information</h5>
                    <hr>

                    <div class="mb-3">
                        <label asp-for="PersonName" class="form-label"></label>
                        <input asp-for="PersonName" class="form-control" placeholder="Enter person's name" />
                        <span asp-validation-for="PersonName" class="text-danger"></span>
                    </div>

                    <h5 class="mt-3">Birth Information</h5>
                    <hr>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="BirthDate" class="form-label"></label>
                            <input asp-for="BirthDate" class="form-control" type="date" />
                            <span asp-validation-for="BirthDate" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="BirthTime" class="form-label"></label>
                            <input asp-for="BirthTime" class="form-control" type="time" />
                            <span asp-validation-for="BirthTime" class="text-danger"></span>
                        </div>
                    </div>

                    <h5 class="mt-3">Birth Location</h5>
                    <hr>

                    <div class="mb-3">
                        <label asp-for="PlaceName" class="form-label"></label>
                        <input asp-for="PlaceName" 
                               id="placeNameInput"
                               class="form-control" 
                               placeholder="Type to search cities (min 2 characters)..."
                               autocomplete="off" />
                        <div id="placeDropdown" class="dropdown-menu" style="max-height: 300px; overflow-y: auto; width: 100%;"></div>
                        <span asp-validation-for="PlaceName" class="text-danger"></span>
                        <small class="form-text text-muted">
                            <i class="bi bi-search"></i> Start typing city name (e.g., Chennai, Mumbai, Delhi)
                        </small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Latitude" class="form-label"></label>
                            <input asp-for="Latitude" class="form-control" placeholder="e.g., 13.0827" step="0.000001" />
                            <span asp-validation-for="Latitude" class="text-danger"></span>
                            <small class="form-text text-muted">North: positive, South: negative</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Longitude" class="form-label"></label>
                            <input asp-for="Longitude" class="form-control" placeholder="e.g., 80.2707" step="0.000001" />
                            <span asp-validation-for="Longitude" class="text-danger"></span>
                            <small class="form-text text-muted">East: positive, West: negative</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="TimeZoneOffset" class="form-label"></label>
                        <select asp-for="TimeZoneOffset" class="form-select">
                            <option value="5.5">India Standard Time (UTC +5:30)</option>
                            <option value="5.75">Nepal Time (UTC +5:45)</option>
                            <option value="6">Bangladesh Time (UTC +6:00)</option>
                            <option value="8">Singapore Time (UTC +8:00)</option>
                            <option value="0">UTC (Greenwich Mean Time)</option>
                        </select>
                        <span asp-validation-for="TimeZoneOffset" class="text-danger"></span>
                    </div>

                    <h5 class="mt-3">Display Preferences</h5>
                    <hr>

                    <div class="mb-3">
                        <label asp-for="Language" class="form-label"></label>
                        <select asp-for="Language" class="form-select">
                            <option value="Tamil">Tamil (தமிழ்)</option>
                            <option value="Telugu">Telugu (తెలుగు)</option>
                            <option value="Kannada">Kannada (ಕನ್ನಡ)</option>
                            <option value="Malayalam">Malayalam (മലയാളം)</option>
                        </select>
                        <span asp-validation-for="Language" class="text-danger"></span>
                        <small class="form-text text-muted">
                            <i class="bi bi-translate"></i> Select language for planet names, rasis, nakshatras, yogas, and doshas
                        </small>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100 mt-3" id="generateBtn">
                        <i class="bi bi-stars"></i> Generate Horoscope
                    </button>
                    
                    @if (Model.Horoscope != null)
                    {
                        <button type="button" class="btn btn-success btn-lg w-100 mt-2" onclick="resetFormForNext()">
                            <i class="bi bi-plus-circle"></i> Generate Next Horoscope
                        </button>
                        
                        <button type="button" class="btn btn-outline-danger btn-lg w-100 mt-2" onclick="exportToPdf()">
                            <i class="bi bi-file-pdf"></i> Export to PDF
                        </button>
                    }
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Major Indian Cities</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>City</th>
                            <th>Lat</th>
                            <th>Lon</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr onclick="setLocation('Chennai', 13.0827, 80.2707)" style="cursor:pointer">
                            <td>Chennai</td>
                            <td>13.08</td>
                            <td>80.27</td>
                        </tr>
                        <tr onclick="setLocation('Mumbai', 19.0760, 72.8777)" style="cursor:pointer">
                            <td>Mumbai</td>
                            <td>19.08</td>
                            <td>72.88</td>
                        </tr>
                        <tr onclick="setLocation('Delhi', 28.7041, 77.1025)" style="cursor:pointer">
                            <td>Delhi</td>
                            <td>28.70</td>
                            <td>77.10</td>
                        </tr>
                        <tr onclick="setLocation('Bangalore', 12.9716, 77.5946)" style="cursor:pointer">
                            <td>Bangalore</td>
                            <td>12.97</td>
                            <td>77.59</td>
                        </tr>
                        <tr onclick="setLocation('Kolkata', 22.5726, 88.3639)" style="cursor:pointer">
                            <td>Kolkata</td>
                            <td>22.57</td>
                            <td>88.36</td>
                        </tr>
                    </tbody>
                </table>
                <small class="text-muted">Click a city to auto-fill location</small>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Features</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><i class="bi bi-check-circle text-success"></i> Birth chart (Rasi)</li>
                    <li><i class="bi bi-check-circle text-success"></i> Planetary positions</li>
                    <li><i class="bi bi-check-circle text-success"></i> Dasa periods</li>
                    @if (!isInTrial)
                    {
                        <li><i class="bi bi-check-circle text-success"></i> Navamsa chart (D-9)</li>
                        <li><i class="bi bi-check-circle text-success"></i> Bhukti sub-periods</li>
                        <li><i class="bi bi-check-circle text-success"></i> Planetary strength</li>
                    }
                    else
                    {
                        <li><i class="bi bi-x-circle text-muted"></i> <span class="text-muted">Navamsa chart (Paid only)</span></li>
                        <li><i class="bi bi-x-circle text-muted"></i> <span class="text-muted">Bhukti sub-periods (Paid only)</span></li>
                        <li><i class="bi bi-x-circle text-muted"></i> <span class="text-muted">Planetary strength (Paid only)</span></li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

@* Display Horoscope Results *@
@if (Model.Horoscope != null)
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="bi bi-stars"></i> Horoscope Results</h4>
                </div>
                <div class="card-body">
                    <h5 id="pdf-section-birthdetails-hdr">Birth Details</h5>
                    <table id="pdf-section-birthdetails" class="table table-bordered">
                        <tr>
                            <th>Name</th>
                            <td><strong>@Model.PersonName</strong></td>
                        </tr>
                        <tr>
                            <th>Date & Time</th>
                            <td>@Model.Horoscope.BirthDetails.DateTime.ToString("dddd, MMMM dd, yyyy HH:mm")</td>
                        </tr>
                        <tr>
                            <th>Place</th>
                            <td>@Model.Horoscope.BirthDetails.PlaceName</td>
                        </tr>
                        <tr>
                            <th>Coordinates</th>
                            <td>Latitude: @Model.Horoscope.BirthDetails.Latitude.ToString("F4")°, Longitude: @Model.Horoscope.BirthDetails.Longitude.ToString("F4")°</td>
                        </tr>
                        <tr>
                            <th>Lagna (Ascendant)</th>
                            <td><strong>@Model.Horoscope.LagnaRasiName (@(Model.Horoscope.Planets.Any() ? TamilHoroscope.Core.Data.TamilNames.GetRasiName(Model.Horoscope.LagnaRasi, Model.Horoscope.Planets.First().Language) : Model.Horoscope.TamilLagnaRasiName))</strong></td>
                        </tr>
                    </table>

                    <h5 id="pdf-section-chart-hdr" class="mt-4">Birth Charts - பிறப்பு சார்ட்கள்</h5>
                    <div id="pdf-section-chart" class="row">
                        <div class="col-md-6">
                            <h6 class="text-center">
                                @TamilHoroscope.Core.Data.TamilNames.GetSectionName("RasiChart", "English") - 
                                @TamilHoroscope.Core.Data.TamilNames.GetSectionName("RasiChart", Model.Language ?? "Tamil")
                            </h6>
                            <div class="d-flex justify-content-center mb-4">
                                <div id="rasiChart" class="south-indian-chart">
                                    <!-- Chart will be generated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        @if (!Model.IsTrialUser && Model.Horoscope.NavamsaPlanets != null && Model.Horoscope.NavamsaPlanets.Any())
                        {
                            <div class="col-md-6">
                                <h6 class="text-center">
                                    @TamilHoroscope.Core.Data.TamilNames.GetSectionName("NavamsaChart", "English") - 
                                    @TamilHoroscope.Core.Data.TamilNames.GetSectionName("NavamsaChart", Model.Language ?? "Tamil")
                                </h6>
                                <div class="d-flex justify-content-center mb-4">
                                    <div id="navamsaChart" class="south-indian-chart">
                                        <!-- Chart will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <h5 id="pdf-section-planetary-positions-hdr" class="mt-4">Planetary Positions</h5>
                    <div id="pdf-section-planetary-positions" class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Planet (@TamilHoroscope.Core.Data.TamilNames.GetSectionName("Planet", Model.Language ?? "Tamil"))</th>
                                    <th>Rasi (@TamilHoroscope.Core.Data.TamilNames.GetSectionName("Rasi", Model.Language ?? "Tamil"))</th>
                                    <th>Nakshatra (@TamilHoroscope.Core.Data.TamilNames.GetSectionName("Nakshatra", Model.Language ?? "Tamil"))</th>
                                    <th>House</th>
                                    <th>Longitude</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var planet in Model.Horoscope.Planets)
                                {
                                    <tr>
                                        <td><strong>@planet.Name</strong> (@planet.LocalizedName)</td>
                                        <td>@planet.RasiName (@planet.LocalizedRasiName)</td>
                                        <td>@planet.NakshatraName (@planet.LocalizedNakshatraName)</td>
                                        <td>House @planet.House</td>
                                        <td>@planet.LongitudeFormatted</td>
                                        <td>
                                            @if (planet.IsRetrograde)
                                            {
                                                <span class="badge bg-warning">Retrograde</span>
                                            }
                                            @if (planet.IsCombust)
                                            {
                                                <span class="badge bg-danger">Combust</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (Model.Horoscope.VimshottariDasas != null && Model.Horoscope.VimshottariDasas.Any())
                    {
                        <h5 id="pdf-section-dasa-bhkthi-hdr" class="mt-4">@TamilHoroscope.Core.Data.TamilNames.GetSectionName("VimshottariDasa", "English") (@TamilHoroscope.Core.Data.TamilNames.GetSectionName("VimshottariDasa", Model.Language ?? "Tamil"))</h5>
                        <div class="accordion" id="dasaAccordion">
                            @for (var i = 0; i < Math.Min(10, Model.Horoscope.VimshottariDasas.Count); i++)
                            {
                                var dasa = Model.Horoscope.VimshottariDasas[i];
                                <div class="accordion-item pdf-export-dasa" data-pdf-section="dasa-bhkthi-@i">
                                    <h2 class="accordion-header" id="dasaHeading@(i)">
                                        <button class="accordion-button @(i > 0 ? "collapsed" : "")" type="button" data-bs-toggle="collapse" data-bs-target="#dasaCollapse@(i)" aria-expanded="@(i == 0 ? "true" : "false")" aria-controls="dasaCollapse@(i)">
                                            <div style="width: 100%;">
                                                <div style="font-weight: bold; font-size: 14px;">@dasa.Lord (@dasa.LocalizedLord) Dasa</div>
                                                <div style="font-size: 12px; color: #666;">@dasa.StartDate.ToString("MMM dd, yyyy") to @dasa.EndDate.ToString("MMM dd, yyyy")</div>
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="dasaCollapse@(i)" class="accordion-collapse collapse @(i == 0 ? "show" : "")" aria-labelledby="dasaHeading@(i)" data-bs-parent="#dasaAccordion">
                                        <div class="accordion-body">
                                            <p><strong>Duration:</strong> @(((dasa.EndDate - dasa.StartDate).TotalDays / 365.25).ToString("F1")) years</p>
                                            
                                            @if (!Model.IsTrialUser && dasa.Bhuktis != null && dasa.Bhuktis.Any())
                                            {
                                                <h6>Bhukti Sub-periods:</h6>
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>Bhukti</th>
                                                                <th>Start Date</th>
                                                                <th>End Date</th>
                                                                <th>Duration</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var bhukti in dasa.Bhuktis)
                                                            {
                                                                <tr>
                                                                    <td>@bhukti.Lord (@bhukti.LocalizedLord)</td>
                                                                    <td>@bhukti.StartDate.ToString("MMM dd, yyyy")</td>
                                                                    <td>@bhukti.EndDate.ToString("MMM dd, yyyy")</td>
                                                                    <td>@((bhukti.DurationDays / 365.25).ToString("F2")) years</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            }
                                            else if (Model.IsTrialUser)
                                            {
                                                <div class="alert alert-info">
                                                    <i class="bi bi-lock"></i> Bhukti sub-periods are available in paid subscription only. <a asp-page="/Wallet/TopUp">Top up your wallet</a> to access full features.
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @if (!Model.IsTrialUser && Model.Horoscope.NavamsaPlanets != null && Model.Horoscope.NavamsaPlanets.Any())
                    {
                        <h6 class="mt-3">Navamsa Planetary Positions</h6>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-secondary">
                                    <tr>
                                        <th>Planet</th>
                                        <th>Navamsa Rasi</th>
                                        <th>Longitude</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var planet in Model.Horoscope.NavamsaPlanets)
                                    {
                                        <tr>
                                            <td>@planet.Name (@planet.LocalizedName)</td>
                                            <td>@planet.RasiName (@planet.LocalizedRasiName)</td>
                                            <td>@planet.LongitudeFormatted</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }

                    @* Planetary Strength Section *@
                    @if (!Model.IsTrialUser && Model.Horoscope.PlanetStrengths != null && Model.Horoscope.PlanetStrengths.Any())
                    {
                        <h5 id="pdf-section-planetary-stength-hdr" class="mt-4">Planetary Strength (Shadbala) - கிரக பலம்</h5>
                        <p class="text-muted small">Note: Rahu and Ketu are excluded as they don't have Shadbala in traditional Vedic astrology.</p>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Planet</th>
                                        <th>Positional</th>
                                        <th>Directional</th>
                                        <th>Motional</th>
                                        <th>Natural</th>
                                        <th>Temporal</th>
                                        <th>Aspectual</th>
                                        <th>Total</th>
                                        <th>Required</th>
                                        <th>Grade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var strength in Model.Horoscope.PlanetStrengths)
                                    {
                                        var gradeClass = strength.StrengthPercentage >= 80 ? "text-success" :
                                                        strength.StrengthPercentage >= 60 ? "text-primary" :
                                                        strength.StrengthPercentage >= 40 ? "text-warning" : "text-danger";
                                        <tr>
                                            <td><strong>@strength.Name</strong><br/><small class="text-muted">@strength.LocalizedName</small></td>
                                            <td class="text-end">@strength.PositionalStrength.ToString("F1")</td>
                                            <td class="text-end">@strength.DirectionalStrength.ToString("F1")</td>
                                            <td class="text-end">@strength.MotionalStrength.ToString("F1")</td>
                                            <td class="text-end">@strength.NaturalStrength.ToString("F1")</td>
                                            <td class="text-end">@strength.TemporalStrength.ToString("F1")</td>
                                            <td class="text-end">@strength.AspectualStrength.ToString("F1")</td>
                                            <td class="text-end"><strong>@strength.TotalStrength.ToString("F1")</strong></td>
                                            <td class="text-end text-danger">@strength.RequiredStrength.ToString("F1")</td>
                                            <td class="text-center"><span class="badge @gradeClass">@strength.StrengthGrade</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        @* Strength Bar Chart *@
                        <div class="mt-3">
                            <canvas id="strengthChart" style="max-height: 400px;"></canvas>
                        </div>

                        <div class="alert alert-info mt-3">
                            <strong>Strength Components Explained:</strong>
                            <ul class="mb-0 small">
                                <li><strong>Positional (Sthana Bala):</strong> Based on sign placement (exaltation, own sign, etc.)</li>
                                <li><strong>Directional (Dig Bala):</strong> Based on house placement relative to cardinal directions</li>
                                <li><strong>Motional (Chesta Bala):</strong> Based on speed and retrograde status</li>
                                <li><strong>Natural (Naisargika Bala):</strong> Inherent luminosity and power of the planet</li>
                                <li><strong>Temporal (Kala Bala):</strong> Based on time factors (day/night, paksha)</li>
                                <li><strong>Aspectual (Drik Bala):</strong> Based on aspects received from other planets</li>
                            </ul>
                            <p class="mb-0 mt-2"><small>Units: Rupas (R). Required minimum strength varies by planet. A planet meeting or exceeding its required minimum can deliver positive results.</small></p>
                        </div>
                    }
                    else if (Model.IsTrialUser)
                    {
                        <div class="alert alert-warning mt-4">
                            <i class="bi bi-lock"></i> <strong>Navamsa Chart</strong> and <strong>Planetary Strength Analysis</strong> are available in paid subscription only. 
                            <a asp-page="/Wallet/TopUp" class="alert-link">Top up your wallet</a> to unlock all features.
                        </div>
                    }

                    @* Yoga Section *@
                    @if (Model.Horoscope.Yogas != null && Model.Horoscope.Yogas.Any())
                    {
                        <h5 id="pdf-section-yogas-hdr" class="mt-4"><i class="bi bi-brightness-high"></i> Astrological Yogas - ஜோதிட யோகங்கள்</h5>
                        <p class="text-muted small">Beneficial planetary combinations detected in your horoscope</p>

                        <div id="pdf-section-yogas" class="row">
                            @foreach (var yoga in Model.Horoscope.Yogas)
                            {
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                @yoga.Name <span class="small">(@yoga.LocalName)</span>
                                                <span class="badge bg-light text-success float-end">Strength: @yoga.Strength/10</span>
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text">@yoga.LocalizedDescription</p>
                                            <p class="mb-0 small text-muted">
                                                <strong>Planets:</strong> @string.Join(", ", yoga.InvolvedPlanets)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @* Dosha Section *@
                    @if (Model.Horoscope.Dosas != null && Model.Horoscope.Dosas.Any())
                    {
                        <h5 id="pdf-section-dosha-hdr" class="mt-4"><i class="bi bi-exclamation-triangle"></i> Astrological Doshas - ஜோதிட தோஷங்கள்</h5>
                        <p class="text-muted small">Astrological afflictions detected in your horoscope</p>

                        <div class="accordion" id="doshaAccordion">
                            @for (int i = 0; i < Model.Horoscope.Dosas.Count; i++)
                            {
                                var dosa = Model.Horoscope.Dosas[i];
                                var collapseId = $"dosha{i}";
                                <div class="accordion-item border-danger pdf-export-dosha" data-pdf-section="dosa-@i">
                                    <h2 class="accordion-header" id="doshaHeading@i">
                                        <button class="accordion-button collapsed bg-danger text-white" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="false" aria-controls="@collapseId">
                                            @dosa.Name <span class="small ms-2">(@dosa.LocalName)</span>
                                            <span class="badge bg-light text-danger ms-auto">Severity: @dosa.Severity/10</span>
                                        </button>
                                    </h2>
                                    <div id="@collapseId" class="accordion-collapse collapse" data-bs-parent="#doshaAccordion">
                                        <div class="accordion-body">
                                            <p><strong>Description:</strong> @dosa.LocalizedDescription</p>
                                            <p class="mb-2 small text-muted">
                                                <strong>Planets:</strong> @string.Join(", ", dosa.InvolvedPlanets)
                                            </p>
                                            
                                            <div class="alert alert-info mt-3">
                                                <h6 class="alert-heading"><i class="bi bi-lightbulb"></i> Remedies</h6>
                                                <ul class="mb-0">
                                                    @foreach (var remedy in dosa.LocalizedRemedies)
                                                    {
                                                        <li>@remedy</li>
                                                    }
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (Model.Horoscope != null)
                    {
                        <div class="alert alert-success mt-4">
                            <i class="bi bi-check-circle"></i> <strong>No doshas detected!</strong> This is a favorable chart.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger mt-4">
        <i class="bi bi-exclamation-triangle"></i> @Model.ErrorMessage
    </div>
}

@section Scripts {
<partial name="_ValidationScriptsPartial" />

<!-- Chart.js for Planetary Strength Bar Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- html2canvas for capturing charts as images -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
<style>
    /* South Indian Style Rasi Chart */
    .south-indian-chart {
        width: 400px;
        height: 400px;
        display: grid;
        grid-template-columns: 100px 100px 100px 100px;
        grid-template-rows: 100px 100px 100px 100px;
        border: 2px solid #F88857;
        background: radial-gradient(circle, #FFFDE9, #FFFCD5);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .chart-box {
        border: 1px solid #F88857;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 5px;
        font-size: 11px;
        position: relative;
        background: #FFFDE9;
    }

    .chart-center {
        grid-column: 2 / 4;
        grid-row: 2 / 4;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        color: #800080;
        border: 1px solid #F88857;
    }

    .lagna-marker {
        background: #DC3545;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: bold;
        margin-bottom: 2px;
    }

    .planet-text {
        color: #800080;
        font-weight: 500;
        margin: 1px;
        font-size: 10px;
        display: inline-block;
    }

        .planets-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2px;
        }

        @@media (max-width: 576px) {
            .south-indian-chart {
                width: 320px;
                height: 320px;
                grid-template-columns: 80px 80px 80px 80px;
                grid-template-rows: 80px 80px 80px 80px;
            }
            .chart-box {
                font-size: 9px;
            }
            .planet-text {
                font-size: 8px;
            }
        }
    </style>

<script>
        // Comprehensive list of Indian and major world cities with coordinates
        const cities = [
            // Tamil Nadu
            { name: "Chennai, Tamil Nadu", lat: 13.0827, lon: 80.2707, tz: 5.5 },
            { name: "Coimbatore, Tamil Nadu", lat: 11.0168, lon: 76.9558, tz: 5.5 },
            { name: "Madurai, Tamil Nadu", lat: 9.9252, lon: 78.1198, tz: 5.5 },
            { name: "Trichy, Tamil Nadu", lat: 10.7905, lon: 78.7047, tz: 5.5 },
            { name: "Salem, Tamil Nadu", lat: 11.6643, lon: 78.1460, tz: 5.5 },
            { name: "Tirunelveli, Tamil Nadu", lat: 8.7139, lon: 77.7567, tz: 5.5 },
            { name: "Vellore, Tamil Nadu", lat: 12.9165, lon: 79.1325, tz: 5.5 },
            { name: "Erode, Tamil Nadu", lat: 11.3410, lon: 77.7172, tz: 5.5 },
            { name: "Tiruppur, Tamil Nadu", lat: 11.1085, lon: 77.3411, tz: 5.5 },
            { name: "Thoothukudi, Tamil Nadu", lat: 8.7642, lon: 78.1348, tz: 5.5 },
            { name: "Thanjavur, Tamil Nadu", lat: 10.7870, lon: 79.1378, tz: 5.5 },
            { name: "Dindigul, Tamil Nadu", lat: 10.3673, lon: 77.9803, tz: 5.5 },
            { name: "Ranipet, Tamil Nadu", lat: 12.9540, lon: 79.3326, tz: 5.5 },
            { name: "Sivakasi, Tamil Nadu", lat: 9.4524, lon: 77.8119, tz: 5.5 },
            { name: "Karur, Tamil Nadu", lat: 10.9601, lon: 78.0766, tz: 5.5 },
            { name: "Kanchipuram, Tamil Nadu", lat: 12.8342, lon: 79.7036, tz: 5.5 },
            { name: "Nagercoil, Tamil Nadu", lat: 8.1776, lon: 77.4342, tz: 5.5 },
            { name: "Kumbakonam, Tamil Nadu", lat: 10.9617, lon: 79.3881, tz: 5.5 },
            { name: "Tiruvallur, Tamil Nadu", lat: 13.1434, lon: 79.9077, tz: 5.5 },
            { name: "Kanyakumari, Tamil Nadu", lat: 8.0883, lon: 77.5385, tz: 5.5 },
            
            // Major Indian Cities
            { name: "Mumbai, Maharashtra", lat: 19.0760, lon: 72.8777, tz: 5.5 },
            { name: "Delhi", lat: 28.7041, lon: 77.1025, tz: 5.5 },
            { name: "Bangalore, Karnataka", lat: 12.9716, lon: 77.5946, tz: 5.5 },
            { name: "Hyderabad, Telangana", lat: 17.3850, lon: 78.4867, tz: 5.5 },
            { name: "Kolkata, West Bengal", lat: 22.5726, lon: 88.3639, tz: 5.5 },
            { name: "Pune, Maharashtra", lat: 18.5204, lon: 73.8567, tz: 5.5 },
            { name: "Ahmedabad, Gujarat", lat: 23.0225, lon: 72.5714, tz: 5.5 },
            { name: "Jaipur, Rajasthan", lat: 26.9124, lon: 75.7873, tz: 5.5 },
            { name: "Surat, Gujarat", lat: 21.1702, lon: 72.8311, tz: 5.5 },
            { name: "Lucknow, Uttar Pradesh", lat: 26.8467, lon: 80.9462, tz: 5.5 },
            { name: "Kanpur, Uttar Pradesh", lat: 26.4499, lon: 80.3319, tz: 5.5 },
            { name: "Nagpur, Maharashtra", lat: 21.1458, lon: 79.0882, tz: 5.5 },
            { name: "Indore, Madhya Pradesh", lat: 22.7196, lon: 75.8577, tz: 5.5 },
            { name: "Thane, Maharashtra", lat: 19.2183, lon: 72.9781, tz: 5.5 },
            { name: "Bhopal, Madhya Pradesh", lat: 23.2599, lon: 77.4126, tz: 5.5 },
            { name: "Visakhapatnam, Andhra Pradesh", lat: 17.6868, lon: 83.2185, tz: 5.5 },
            { name: "Pimpri-Chinchwad, Maharashtra", lat: 18.6298, lon: 73.7997, tz: 5.5 },
            { name: "Patna, Bihar", lat: 25.5941, lon: 85.1376, tz: 5.5 },
            { name: "Vadodara, Gujarat", lat: 22.3072, lon: 73.1812, tz: 5.5 },
            { name: "Ghaziabad, Uttar Pradesh", lat: 28.6692, lon: 77.4538, tz: 5.5 },
            { name: "Ludhiana, Punjab", lat: 30.9010, lon: 75.8573, tz: 5.5 },
            { name: "Agra, Uttar Pradesh", lat: 27.1767, lon: 78.0081, tz: 5.5 },
            { name: "Nashik, Maharashtra", lat: 19.9975, lon: 73.7898, tz: 5.5 },
            { name: "Faridabad, Haryana", lat: 28.4089, lon: 77.3178, tz: 5.5 },
            { name: "Meerut, Uttar Pradesh", lat: 28.9845, lon: 77.7064, tz: 5.5 },
            { name: "Rajkot, Gujarat", lat: 22.3039, lon: 70.8022, tz: 5.5 },
            { name: "Kalyan-Dombivli, Maharashtra", lat: 19.2403, lon: 73.1305, tz: 5.5 },
            { name: "Vasai-Virar, Maharashtra", lat: 19.4612, lon: 72.7985, tz: 5.5 },
            { name: "Varanasi, Uttar Pradesh", lat: 25.3176, lon: 82.9739, tz: 5.5 },
            { name: "Srinagar, Jammu and Kashmir", lat: 34.0837, lon: 74.7973, tz: 5.5 },
            { name: "Aurangabad, Maharashtra", lat: 19.8762, lon: 75.3433, tz: 5.5 },
            { name: "Dhanbad, Jharkhand", lat: 23.7957, lon: 86.4304, tz: 5.5 },
            { name: "Amritsar, Punjab", lat: 31.6340, lon: 74.8723, tz: 5.5 },
            { name: "Navi Mumbai, Maharashtra", lat: 19.0330, lon: 73.0297, tz: 5.5 },
            { name: "Allahabad (Prayagraj), Uttar Pradesh", lat: 25.4358, lon: 81.8463, tz: 5.5 },
            { name: "Ranchi, Jharkhand", lat: 23.3441, lon: 85.3096, tz: 5.5 },
            { name: "Howrah, West Bengal", lat: 22.5958, lon: 88.2636, tz: 5.5 },
            { name: "Jabalpur, Madhya Pradesh", lat: 23.1815, lon: 79.9864, tz: 5.5 },
            { name: "Gwalior, Madhya Pradesh", lat: 26.2183, lon: 78.1828, tz: 5.5 },
            { name: "Vijayawada, Andhra Pradesh", lat: 16.5062, lon: 80.6480, tz: 5.5 },
            { name: "Jodhpur, Rajasthan", lat: 26.2389, lon: 73.0243, tz: 5.5 },
            { name: "Raipur, Chhattisgarh", lat: 21.2514, lon: 81.6296, tz: 5.5 },
            { name: "Kota, Rajasthan", lat: 25.2138, lon: 75.8648, tz: 5.5 },
            
            // Kerala
            { name: "Thiruvananthapuram, Kerala", lat: 8.5241, lon: 76.9366, tz: 5.5 },
            { name: "Kochi, Kerala", lat: 9.9312, lon: 76.2673, tz: 5.5 },
            { name: "Kozhikode, Kerala", lat: 11.2588, lon: 75.7804, tz: 5.5 },
            { name: "Thrissur, Kerala", lat: 10.5276, lon: 76.2144, tz: 5.5 },
            { name: "Kollam, Kerala", lat: 8.8932, lon: 76.6141, tz: 5.5 },
            { name: "Kannur, Kerala", lat: 11.8745, lon: 75.3704, tz: 5.5 },
            { name: "Palakkad, Kerala", lat: 10.7867, lon: 76.6548, tz: 5.5 },
            
            // Karnataka
            { name: "Mysore, Karnataka", lat: 12.2958, lon: 76.6394, tz: 5.5 },
            { name: "Mangalore, Karnataka", lat: 12.9141, lon: 74.8560, tz: 5.5 },
            { name: "Hubli, Karnataka", lat: 15.3647, lon: 75.1240, tz: 5.5 },
            { name: "Belgaum, Karnataka", lat: 15.8497, lon: 74.4977, tz: 5.5 },
            
            // Andhra Pradesh & Telangana
            { name: "Tirupati, Andhra Pradesh", lat: 13.6288, lon: 79.4192, tz: 5.5 },
            { name: "Guntur, Andhra Pradesh", lat: 16.3067, lon: 80.4365, tz: 5.5 },
            { name: "Warangal, Telangana", lat: 17.9784, lon: 79.6004, tz: 5.5 },
            
            // International Cities
            { name: "New York, USA", lat: 40.7128, lon: -74.0060, tz: -5 },
            { name: "London, UK", lat: 51.5074, lon: -0.1278, tz: 0 },
            { name: "Paris, France", lat: 48.8566, lon: 2.3522, tz: 1 },
            { name: "Dubai, UAE", lat: 25.2048, lon: 55.2708, tz: 4 },
            { name: "Singapore", lat: 1.3521, lon: 103.8198, tz: 8 },
            { name: "Tokyo, Japan", lat: 35.6762, lon: 139.6503, tz: 9 },
            { name: "Sydney, Australia", lat: -33.8688, lon: 151.2093, tz: 10 },
            { name: "Toronto, Canada", lat: 43.6532, lon: -79.3832, tz: -5 },
            { name: "Los Angeles, USA", lat: 34.0522, lon: -118.2437, tz: -8 },
            { name: "Berlin, Germany", lat: 52.5200, lon: 13.4050, tz: 1 },
            { name: "Hong Kong", lat: 22.3193, lon: 114.1694, tz: 8 },
            { name: "Kuala Lumpur, Malaysia", lat: 3.1390, lon: 101.6869, tz: 8 },
            { name: "Bangkok, Thailand", lat: 13.7563, lon: 100.5018, tz: 7 },
            { name: "Shanghai, China", lat: 31.2304, lon: 121.4737, tz: 8 },
            { name: "Seoul, South Korea", lat: 37.5665, lon: 126.9780, tz: 9 }
        ];

        let selectedCityIndex = -1;

        // Initialize autocomplete
        document.addEventListener('DOMContentLoaded', function() {
            const placeInput = document.getElementById('placeNameInput');
            const dropdown = document.getElementById('placeDropdown');
            
            if (!placeInput || !dropdown) return;

            // Handle input changes
            placeInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase().trim();
                
                if (searchText.length === 0) {
                    dropdown.classList.remove('show');
                    dropdown.innerHTML = '';
                    return;
                }

                // Filter cities
                const matches = cities.filter(city => 
                    city.name.toLowerCase().includes(searchText)
                ).slice(0, 10); // Limit to 10 results

                if (matches.length === 0) {
                    dropdown.classList.remove('show');
                    dropdown.innerHTML = '';
                    return;
                }

                // Build dropdown HTML
                dropdown.innerHTML = matches.map((city, index) => 
                    `<a href="#" class="dropdown-item" data-index="${index}" data-city="${city.name}" data-lat="${city.lat}" data-lon="${city.lon}" data-tz="${city.tz}">
                        <i class="bi bi-geo-alt-fill text-primary me-2"></i>${city.name}
                    </a>`
                ).join('');

                dropdown.classList.add('show');
                selectedCityIndex = -1;
            });

            // Handle dropdown clicks
            dropdown.addEventListener('click', function(e) {
                e.preventDefault();
                const item = e.target.closest('.dropdown-item');
                if (!item) return;

                const cityName = item.dataset.city;
                const lat = parseFloat(item.dataset.lat);
                const lon = parseFloat(item.dataset.lon);
                const tz = parseFloat(item.dataset.tz);

                setLocationFromAutocomplete(cityName, lat, lon, tz);
                dropdown.classList.remove('show');
            });

            // Handle keyboard navigation
            placeInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.dropdown-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedCityIndex = Math.min(selectedCityIndex + 1, items.length - 1);
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedCityIndex = Math.max(selectedCityIndex - 1, 0);
                    updateSelection(items);
                } else if (e.key === 'Enter' && selectedCityIndex >= 0) {
                    e.preventDefault();
                    items[selectedCityIndex].click();
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!placeInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            function updateSelection(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('active', index === selectedCityIndex);
                });
                if (selectedCityIndex >= 0) {
                    items[selectedCityIndex].scrollIntoView({ block: 'nearest' });
                }
            }
        });

        function setLocationFromAutocomplete(place, lat, lon, tz) {
            const placeInput = document.querySelector('input[name="PlaceName"]');
            const latInput = document.querySelector('input[name="Latitude"]');
            const lonInput = document.querySelector('input[name="Longitude"]');
            const tzSelect = document.querySelector('select[name="TimeZoneOffset"]');
            
            if (placeInput) placeInput.value = place;
            if (latInput) latInput.value = lat.toFixed(6);
            if (lonInput) lonInput.value = lon.toFixed(6);
            
            // Set timezone or default to IST
            if (tzSelect) {
                // Find the closest timezone option
                const options = Array.from(tzSelect.options);
                const closestOption = options.reduce((prev, curr) => {
                    return Math.abs(parseFloat(curr.value) - tz) < Math.abs(parseFloat(prev.value) - tz) ? curr : prev;
                });
                tzSelect.value = closestOption.value;
            }
            
            // Visual feedback
            highlightField(placeInput);
            highlightField(latInput);
            highlightField(lonInput);
        }

        function setLocation(place, lat, lon) {
            setLocationFromAutocomplete(place, lat, lon, 5.5);
        }

        function highlightField(field) {
            if (!field) return;
            field.classList.add('bg-warning', 'bg-opacity-25');
            setTimeout(() => {
                field.classList.remove('bg-warning', 'bg-opacity-25');
            }, 1000);
        }

        // Reset form for next horoscope generation
        function resetFormForNext() {
            // Clear all form fields
            const personNameInput = document.querySelector('input[name="PersonName"]');
            const birthDateInput = document.querySelector('input[name="BirthDate"]');
            const birthTimeInput = document.querySelector('input[name="BirthTime"]');
            const placeNameInput = document.querySelector('input[name="PlaceName"]');
            const latInput = document.querySelector('input[name="Latitude"]');
            const lonInput = document.querySelector('input[name="Longitude"]');
            const tzSelect = document.querySelector('select[name="TimeZoneOffset"]');

            if (personNameInput) personNameInput.value = '';
            if (birthDateInput) birthDateInput.value = '';
            if (birthTimeInput) birthTimeInput.value = '';
            if (placeNameInput) placeNameInput.value = '';
            if (latInput) latInput.value = '13.0827'; // Default Chennai
            if (lonInput) lonInput.value = '80.2707'; // Default Chennai
            if (tzSelect) tzSelect.value = '5.5'; // Default IST

            // IMPORTANT: Clear security tokens to force regeneration
            document.getElementById('requestToken').value = '';
            document.getElementById('requestTimestamp').value = '';
            document.getElementById('birthDetailsChecksum').value = '';

            // Reset the token generation flag
            if (window.tokenGenerationState) {
                window.tokenGenerationState.isTokensGenerated = false;
            }

            // Hide results section
            const resultsSection = document.querySelector('.row.mt-4');
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }

            // Scroll to top of form
            const formTop = document.querySelector('.card-header');
            if (formTop) {
                formTop.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // Focus on person name field
            if (personNameInput) {
                setTimeout(() => personNameInput.focus(), 300);
            }
        }

        // Rasi Chart Drawing Function
        function drawRasiChart(horoscopeData, language) {
            const chartTitles = {
                English: 'Rasi',
                Tamil: 'ராசி',
                Telugu: 'రాశి',
                Kannada: 'ರಾಶಿ',
                Malayalam: 'രാശി'
            };
            const title = chartTitles[language] || chartTitles.Tamil;
            drawChart(horoscopeData, 'rasiChart', horoscopeData.Planets, horoscopeData.LagnaRasi, title, language);
        }

        // Navamsa Chart Drawing Function
        function drawNavamsaChart(horoscopeData, language) {
            if (horoscopeData.NavamsaPlanets && horoscopeData.NavamsaPlanets.length > 0) {
                const chartTitles = {
                    English: 'Navamsa',
                    Tamil: 'நவாம்சம்',
                    Telugu: 'నవాంశం',
                    Kannada: 'ನವಾಂಶ',
                    Malayalam: 'നവാംശം'
                };
                const title = chartTitles[language] || chartTitles.Tamil;
                // For Navamsa, we don't show Lagna marker (or we can calculate Navamsa Lagna if available)
                drawChart(horoscopeData, 'navamsaChart', horoscopeData.NavamsaPlanets, null, title, language);
            }
        }

        // Generic chart drawing function for both Rasi and Navamsa
        function drawChart(horoscopeData, containerId, planetsData, lagnaRasi, title, language) {
            const chartContainer = document.getElementById(containerId);
            if (!chartContainer || !horoscopeData) return;

            // Clear existing content
            chartContainer.innerHTML = '';

            // Planet abbreviations in multiple languages
            const planetAbbrev = {
                'Sun': {
                    English: 'Sun',
                    Tamil: 'சூரி',
                    Telugu: 'సూర్య',
                    Kannada: 'ಸೂರ್ಯ',
                    Malayalam: 'സൂര്യ'
                },
                'Moon': {
                    English: 'Moon',
                    Tamil: 'சந்',
                    Telugu: 'చంద్ర',
                    Kannada: 'ಚಂದ್ರ',
                    Malayalam: 'ചന്ദ്ര'
                },
                'Mars': {
                    English: 'Mars',
                    Tamil: 'செவ்',
                    Telugu: 'కుజ',
                    Kannada: 'ಮಂಗಳ',
                    Malayalam: 'ചൊവ്വ'
                },
                'Mercury': {
                    English: 'Merc',
                    Tamil: 'புத',
                    Telugu: 'బుధ',
                    Kannada: 'ಬುಧ',
                    Malayalam: 'ബുധ'
                },
                'Jupiter': {
                    English: 'Jup',
                    Tamil: 'குரு',
                    Telugu: 'గురు',
                    Kannada: 'ಗುರು',
                    Malayalam: 'ഗുരു'
                },
                'Venus': {
                    English: 'Venus',
                    Tamil: 'சுக்',
                    Telugu: 'శుక్ర',
                    Kannada: 'ಶುಕ್ರ',
                    Malayalam: 'ശുക്ര'
                },
                'Saturn': {
                    English: 'Sat',
                    Tamil: 'சனி',
                    Telugu: 'శని',
                    Kannada: 'ಶನಿ',
                    Malayalam: 'ശനി'
                },
                'Rahu': {
                    English: 'Rahu',
                    Tamil: 'ராகு',
                    Telugu: 'రాహు',
                    Kannada: 'ರಾಹು',
                    Malayalam: 'രാഹു'
                },
                'Ketu': {
                    English: 'Ketu',
                    Tamil: 'கேது',
                    Telugu: 'కేతు',
                    Kannada: 'ಕೇತು',
                    Malayalam: 'കേതു'
                }
            };

            // Lagna marker text in multiple languages
            const lagnaText = {
                English: 'Lag',
                Tamil: 'லக்',
                Telugu: 'లగ్',
                Kannada: 'ಲಗ್',
                Malayalam: 'ലഗ്'
            };

            // Group planets by Rasi
            const rasiToPlanets = {};
            for (let i = 1; i <= 12; i++) {
                rasiToPlanets[i] = [];
            }

            planetsData.forEach(planet => {
                const abbrev = planetAbbrev[planet.Name] 
                    ? (planetAbbrev[planet.Name][language] || planetAbbrev[planet.Name].Tamil)
                    : planet.Name.substring(0, 2);
                rasiToPlanets[planet.Rasi].push(abbrev);
            });

            // South Indian chart positions (4x4 grid)
            // Layout: 12  1   2   3
            //         11 [CENTER] 4
            //         10 [CENTER] 5
            //          9  8   7   6
            const boxPositions = [
                { gridRow: 1, gridCol: 1, rasi: 12 },  // Pisces
                { gridRow: 1, gridCol: 2, rasi: 1 },   // Aries
                { gridRow: 1, gridCol: 3, rasi: 2 },   // Taurus
                { gridRow: 1, gridCol: 4, rasi: 3 },   // Gemini
                { gridRow: 2, gridCol: 4, rasi: 4 },   // Cancer
                { gridRow: 3, gridCol: 4, rasi: 5 },   // Leo
                { gridRow: 4, gridCol: 4, rasi: 6 },   // Virgo
                { gridRow: 4, gridCol: 3, rasi: 7 },   // Libra
                { gridRow: 4, gridCol: 2, rasi: 8 },   // Scorpio
                { gridRow: 4, gridCol: 1, rasi: 9 },   // Sagittarius
                { gridRow: 3, gridCol: 1, rasi: 10 },  // Capricorn
                { gridRow: 2, gridCol: 1, rasi: 11 }   // Aquarius
            ];

            // Create all 12 boxes
            boxPositions.forEach(pos => {
                const box = document.createElement('div');
                box.className = 'chart-box';
                box.style.gridRow = pos.gridRow;
                box.style.gridColumn = pos.gridCol;

                // Add Lagna marker if this is the Lagna rasi
                if (lagnaRasi && pos.rasi === lagnaRasi) {
                    const lagnaMarker = document.createElement('div');
                    lagnaMarker.className = 'lagna-marker';
                    lagnaMarker.textContent = lagnaText[language] || lagnaText.Tamil;
                    box.appendChild(lagnaMarker);
                }

                // Add planets in this rasi
                const planets = rasiToPlanets[pos.rasi];
                if (planets.length > 0) {
                    const planetsContainer = document.createElement('div');
                    planetsContainer.className = 'planets-container';
                    planets.forEach(planetAbbrev => {
                        const planetSpan = document.createElement('span');
                        planetSpan.className = 'planet-text';
                        planetSpan.textContent = planetAbbrev;
                        planetsContainer.appendChild(planetSpan);
                    });
                    box.appendChild(planetsContainer);
                }

                // Optionally add Rasi number or name as a subtle label (bottom-right corner)
                const rasiLabel = document.createElement('div');
                rasiLabel.className = 'rasi-label';
                rasiLabel.textContent = getRasiName(pos.rasi, language);
                rasiLabel.style.fontSize = '8px';
                rasiLabel.style.color = '#999';
                rasiLabel.style.position = 'absolute';
                rasiLabel.style.bottom = '2px';
                rasiLabel.style.right = '2px';
                rasiLabel.style.lineHeight = '1';
                box.appendChild(rasiLabel);

                chartContainer.appendChild(box);
            });

            // Add center title
            const centerBox = document.createElement('div');
            centerBox.className = 'chart-center';
            centerBox.textContent = title;
            chartContainer.appendChild(centerBox);
        }

        // Multi-language support: Rasi names in different languages
        const rasiNames = {
            1: { English: "Aries", Tamil: "மேஷம்", Telugu: "మేషం", Kannada: "ಮೇಷ", Malayalam: "മേടം" },
            2: { English: "Taurus", Tamil: "ரிஷபம்", Telugu: "వృషభం", Kannada: "ವೃಷಭ", Malayalam: "ഇടവം" },
            3: { English: "Gemini", Tamil: "மிதுனம்", Telugu: "మిథునం", Kannada: "ಮಿಥುನ", Malayalam: "മിഥുനം" },
            4: { English: "Cancer", Tamil: "கடகம்", Telugu: "కర్కాటకం", Kannada: "ಕರ್ಕಾಟಕ", Malayalam: "കർക്കിടകം" },
            5: { English: "Leo", Tamil: "சிம்மம்", Telugu: "సింహం", Kannada: "ಸಿಂಹ", Malayalam: "ചിങ്ങം" },
            6: { English: "Virgo", Tamil: "கன்னி", Telugu: "కన్య", Kannada: "ಕನ್ಯಾ", Malayalam: "കന്നി" },
            7: { English: "Libra", Tamil: "துலாம்", Telugu: "తుల", Kannada: "ತುಲಾ", Malayalam: "തുലാം" },
            8: { English: "Scorpio", Tamil: "விருச்சிகம்", Telugu: "వృశ్చికం", Kannada: "ವೃಶ್ಚಿಕ", Malayalam: "വൃശ്ചികം" },
            9: { English: "Sagittarius", Tamil: "தனுசு", Telugu: "ధనస్సు", Kannada: "ಧನು", Malayalam: "ധനു" },
            10: { English: "Capricorn", Tamil: "மகரம்", Telugu: "మకరం", Kannada: "ಮಕರ", Malayalam: "മകరം" },
            11: { English: "Aquarius", Tamil: "கும்பம்", Telugu: "కుంభం", Kannada: "ಕುಂಭ", Malayalam: "കുംഭം" },
            12: { English: "Pisces", Tamil: "மீனம்", Telugu: "మీనం", Kannada: "ಮೀನ", Malayalam: "മീനം" }
        };

        // Get Rasi name in selected language
        function getRasiName(rasiNumber, language) {
            if (rasiNames[rasiNumber] && rasiNames[rasiNumber][language]) {
                return rasiNames[rasiNumber][language];
            }
            return rasiNames[rasiNumber]?.English || '';
        }

        // Auto-draw charts if horoscope data exists on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we have horoscope data in the page (from Model.Horoscope)
            @if (Model.Horoscope != null)
            {
                <text>
                const horoscopeData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Horoscope));
                const selectedLanguage = '@Model.Language' || 'Tamil';
                
                // IMPORTANT: Reset token generation flag when loading from history
                // This ensures tokens are regenerated on next submission
                if (window.tokenGenerationState) {
                    window.tokenGenerationState.isTokensGenerated = false;
                }
                
                // Draw Rasi chart (always shown)
                drawRasiChart(horoscopeData, selectedLanguage);
                
                // Draw Navamsa chart (only for paid users)
                @if (!Model.IsTrialUser)
                {
                    <text>
                    drawNavamsaChart(horoscopeData, selectedLanguage);
                    
                    // Draw Planetary Strength Bar Chart
                    if (horoscopeData.PlanetStrengths && horoscopeData.PlanetStrengths.length > 0) {
                        drawStrengthChart(horoscopeData.PlanetStrengths);
                    }
                    </text>
                }
                </text>
            }
        });

        // Function to draw Planetary Strength Bar Chart using Chart.js
        function drawStrengthChart(strengthData) {
            const canvas = document.getElementById('strengthChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            const labels = strengthData.map(s => s.Name);
            const totalStrengths = strengthData.map(s => s.TotalStrength);
            const requiredStrengths = strengthData.map(s => s.RequiredStrength);
            const percentages = strengthData.map(s => s.StrengthPercentage);
            
            // Color based on percentage
            const colors = percentages.map(p => {
                if (p >= 80) return 'rgba(34, 139, 34, 0.8)';   // Green
                if (p >= 60) return 'rgba(50, 205, 50, 0.8)';   // Light Green
                if (p >= 40) return 'rgba(255, 215, 0, 0.8)';   // Gold
                if (p >= 20) return 'rgba(255, 140, 0, 0.8)';   // Orange
                return 'rgba(220, 20, 60, 0.8)';                 // Red
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Strength (Rupas)',
                            data: totalStrengths,
                            backgroundColor: colors,
                            borderColor: colors.map(c => c.replace('0.8', '1')),
                            borderWidth: 2
                        },
                        {
                            label: 'Required Strength (Rupas)',
                            data: requiredStrengths,
                            backgroundColor: 'rgba(220, 20, 60, 0.3)',
                            borderColor: 'rgba(220, 20, 60, 1)',
                            borderWidth: 1,
                            type: 'line'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Planetary Strength (Shadbala) - கிரக பலம்',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const strength = strengthData[index];
                                    if (context.datasetIndex === 0) {
                                        return `Total: ${strength.TotalStrength.toFixed(1)} Rupas (${strength.StrengthPercentage.toFixed(0)}%) - ${strength.StrengthGrade}`;
                                    }
                                    return `Required: ${strength.RequiredStrength.toFixed(1)} Rupas`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Strength (Rupas)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Planets'
                            }
                        }
                    }
                }
            });
        }

        // =====================================================================
        // SECTION-BY-SECTION PDF EXPORT (BEST QUALITY - NO TINY TEXT!)
        // =====================================================================
        async function exportToPdf() {
            @if (Model.Horoscope != null)
            {
                <text>
                try {
                    const exportBtn = event.target;
                    const originalText = exportBtn.innerHTML;
                    exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Starting export...';
                    exportBtn.disabled = true;

                    const horoscopeData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Horoscope));
                    const personName = '@Model.PersonName';
                    const language = '@Model.Language';

                    // ===========================================
                    // STEP 1: EXPAND ALL ACCORDIONS & FORCE DISPLAY
                    // ===========================================
                    exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Expanding sections...';
                    
                    const accordionStates = [];
                    
                    // Expand all Dasa accordion items and force display
                    document.querySelectorAll('#dasaAccordion .accordion-collapse').forEach(item => {
                        accordionStates.push({ 
                            element: item, 
                            wasShown: item.classList.contains('show'),
                            originalDisplay: item.style.display 
                        });
                        item.classList.add('show');
                        item.style.display = 'block'; // Force display
                        item.style.height = 'auto'; // Force height
                    });
                    
                    // Expand all Dosha accordion items and force display
                    document.querySelectorAll('#doshaAccordion .accordion-collapse').forEach(item => {
                        accordionStates.push({ 
                            element: item, 
                            wasShown: item.classList.contains('show'),
                            originalDisplay: item.style.display 
                        });
                        item.classList.add('show');
                        item.style.display = 'block'; // Force display
                        item.style.height = 'auto'; // Force height
                    });
                    
                    console.log(`Expanded ${accordionStates.length} accordion sections`);
                    
                    // Wait longer for DOM to settle and animations to complete
                    await new Promise(resolve => setTimeout(resolve, 1200));

                    // ===========================================
                    // STEP 2: HIDE EXPORT BUTTONS
                    // ===========================================
                    const buttonsToHide = document.querySelectorAll('.btn-success, .btn-outline-danger');
                    buttonsToHide.forEach(btn => {
                        btn.dataset.originalDisplay = btn.style.display;
                        btn.style.display = 'none';
                    });

                    // ===========================================
                    // STEP 3: CAPTURE EACH SECTION SEPARATELY
                    // ===========================================
                    const sectionImages = {};
                    
                    // Helper function to capture section with header
                    const captureSectionWithHeader = (headerId, contentId) => {
                        const header = document.getElementById(headerId);
                        const content = document.getElementById(contentId);
                        
                        if (!header || !content) return null;
                        
                        // Create a temporary wrapper to capture both header and content
                        const wrapper = document.createElement('div');
                        wrapper.style.backgroundColor = '#ffffff';
                        wrapper.style.padding = '15px';
                        
                        // Clone header and content
                        const headerClone = header.cloneNode(true);
                        const contentClone = content.cloneNode(true);
                        
                        wrapper.appendChild(headerClone);
                        wrapper.appendChild(contentClone);
                        
                        // Add to DOM temporarily
                        document.body.appendChild(wrapper);
                        return wrapper;
                    };
                    
                    // Helper function to capture accordion sections (Dasa/Dosha)
                    const captureAccordionSection = (headerId, accordionName) => {
                        const header = document.getElementById(headerId);
                        const accordion = document.querySelector(`[name="${accordionName}"]`);
                        
                        if (!header || !accordion) return null;
                        
                        // Create wrapper
                        const wrapper = document.createElement('div');
                        wrapper.style.backgroundColor = '#ffffff';
                        wrapper.style.padding = '15px';
                        
                        // Clone and add
                        wrapper.appendChild(header.cloneNode(true));
                        wrapper.appendChild(accordion.cloneNode(true));
                        
                        document.body.appendChild(wrapper);
                        return wrapper;
                    };
                    
                    // Section selectors using your ID/name attributes
                    const sections = {
                        birthDetails: document.getElementById('pdf-section-birthdetails'),
                        charts: document.getElementById('pdf-section-chart'),
                        planetaryPositions: document.getElementById('pdf-section-planetary-positions')
                    };
                    
                    // Capture all Dasa accordion items - entire accordion-item div (includes header + body)
                    const dasaItems = document.querySelectorAll('.pdf-export-dasa[data-pdf-section^="dasa-bhkthi-"]');
                    console.log(`Found ${dasaItems.length} Dasa accordion items`);
                    dasaItems.forEach((item, index) => {
                        const buttonText = item.querySelector('.accordion-button strong')?.textContent;
                        const collapseDiv = item.querySelector('.accordion-collapse');
                        const accordionBody = item.querySelector('.accordion-body');
                        const isVisible = collapseDiv && collapseDiv.classList.contains('show');
                        const height = collapseDiv ? collapseDiv.scrollHeight : 0;
                        const bodyHeight = accordionBody ? accordionBody.scrollHeight : 0;
                        console.log(`  Dasa ${index}: ${buttonText} | Visible: ${isVisible} | Collapse Height: ${height}px | Body Height: ${bodyHeight}px`);
                        
                        // Verify content is actually there
                        if (accordionBody) {
                            const tableRows = accordionBody.querySelectorAll('table tbody tr');
                            console.log(`    → Contains ${tableRows.length} Bhukti rows`);
                        }
                        
                        sections[`dasa${index}`] = item;
                    });
                    
                    // Capture all Dosha accordion items - entire accordion-item div (includes header + body)
                    const doshaItems = document.querySelectorAll('.pdf-export-dosha[data-pdf-section^="dosa-"]');
                    console.log(`Found ${doshaItems.length} Dosha accordion items`);
                    doshaItems.forEach((item, index) => {
                        const buttonText = item.querySelector('.accordion-button')?.textContent;
                        const collapseDiv = item.querySelector('.accordion-collapse');
                        const accordionBody = item.querySelector('.accordion-body');
                        const isVisible = collapseDiv && collapseDiv.classList.contains('show');
                        const height = collapseDiv ? collapseDiv.scrollHeight : 0;
                        const bodyHeight = accordionBody ? accordionBody.scrollHeight : 0;
                        console.log(`  Dosha ${index}: ${buttonText?.trim().substring(0, 50)} | Visible: ${isVisible} | Collapse Height: ${height}px | Body Height: ${bodyHeight}px`);
                        
                        // Verify content is actually there
                        if (accordionBody) {
                            const remedyItems = accordionBody.querySelectorAll('ul li');
                            console.log(`    → Contains ${remedyItems.length} remedies`);
                        }
                        
                        sections[`dosha${index}`] = item;
                    });
                    
                    // Try to find Navamsa and Strength sections (paid users only)
                    const navamsaH6 = Array.from(document.querySelectorAll('h6')).find(h6 => h6.textContent.includes('Navamsa Planetary'));
                    if (navamsaH6) {
                        sections.navamsaPositions = navamsaH6.nextElementSibling;
                    }
                    
                    const strengthHeader = document.getElementById('pdf-section-planetary-stength-hdr');
                    if (strengthHeader) {
                        // Find the content div after the header
                        let nextEl = strengthHeader.nextElementSibling;
                        while (nextEl && nextEl.tagName === 'P') {
                            nextEl = nextEl.nextElementSibling; // Skip <p> tags
                        }
                        sections.strength = nextEl; // Should be the table-responsive div
                    }
                    
                    // Yogas section
                    const yogasSection = document.getElementById('pdf-section-yogas');
                    if (yogasSection) {
                        sections.yogas = yogasSection;
                    }
                    
                    // Log found sections for debugging
                    console.log('=== SECTIONS FOUND ===');
                    Object.entries(sections).forEach(([name, element]) => {
                        if (element) {
                            console.log(`✅ ${name}: FOUND (${element.tagName}, ${element.scrollWidth}x${element.scrollHeight})`);
                        }
                    });
                    console.log(`Total sections to capture: ${Object.keys(sections).filter(k => sections[k]).length}`);
                    console.log('======================');
                    
                    // Capture each section
                    let captured = 0;
                    const totalSections = Object.keys(sections).filter(k => sections[k] !== null && sections[k] !== undefined).length;
                    const tempWrappers = []; // Track temporary wrappers for cleanup
                    
                    for (const [name, element] of Object.entries(sections)) {
                        if (element) {
                            captured++;
                            exportBtn.innerHTML = `<i class="bi bi-hourglass-split"></i> Capturing ${name} (${captured}/${totalSections})...`;
                            
                            try {
                                // Small delay before capturing each section
                                await new Promise(resolve => setTimeout(resolve, 100));
                                
                                // Log element details before capture
                                console.log(`Capturing ${name}: Width=${element.scrollWidth}px, Height=${element.scrollHeight}px`);
                                
                                // Capture directly - no wrapper needed since sections already have proper boundaries
                                sectionImages[name] = await html2canvas(element, {
                                    backgroundColor: '#ffffff',
                                    scale: 2, // Good quality
                                    logging: true, // Enable logging to see what's happening
                                    useCORS: true,
                                    allowTaint: true,
                                    width: element.scrollWidth,
                                    height: element.scrollHeight,
                                    windowWidth: element.scrollWidth,
                                    windowHeight: element.scrollHeight
                                }).then(canvas => {
                                    console.log(`  → Captured canvas: ${canvas.width}x${canvas.height}px`);
                                    const dataUrl = canvas.toDataURL('image/png');
                                    const sizeKB = (dataUrl.length / 1024).toFixed(2);
                                    console.log(`  → Image size: ${sizeKB} KB`);
                                    return dataUrl;
                                });
                            } catch (err) {
                                console.error(`Failed to capture ${name}:`, err);
                            }
                        }
                    }
                    
                    // Cleanup temporary wrappers
                    tempWrappers.forEach(wrapper => {
                        if (wrapper && wrapper.parentNode) {
                            wrapper.parentNode.removeChild(wrapper);
                        }
                    });

                    // ===========================================
                    // STEP 4: RESTORE ORIGINAL STATE
                    // ===========================================
                    accordionStates.forEach(state => {
                        if (!state.wasShown) {
                            state.element.classList.remove('show');
                        }
                        // Restore original display style
                        if (state.originalDisplay !== undefined) {
                            state.element.style.display = state.originalDisplay;
                            state.element.style.height = '';
                        }
                    });
                    buttonsToHide.forEach(btn => {
                        btn.style.display = btn.dataset.originalDisplay || '';
                    });

                    // ===========================================
                    // STEP 5: SEND TO SERVER (SECTION MODE!)
                    // ===========================================
                    exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating PDF...';
                    
                    // Log total payload size
                    const totalImageSizeKB = Object.values(sectionImages).reduce((sum, img) => sum + (img.length / 1024), 0);
                    console.log(`Total image payload: ${totalImageSizeKB.toFixed(2)} KB`);
                    console.log(`Sending ${Object.keys(sectionImages).length} images to server`);
                    
                    const requestData = {
                        horoscopeJson: JSON.stringify(horoscopeData),
                        personName: personName,
                        language: language,
                        useSectionMode: true,  // ← ENABLE SECTION MODE!
                        sectionImages: sectionImages
                    };

                    const response = await fetch('/api/PdfExport/export', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    console.log(`Server response status: ${response.status}`);
                    console.log(`Server response size: ${response.headers.get('content-length')} bytes`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Server error response:', errorText);
                        throw new Error('PDF generation failed: ' + errorText);
                    }

                    // ===========================================
                    // STEP 6: DOWNLOAD PDF
                    // ===========================================
                    exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Downloading...';
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.headers.get('content-disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'horoscope.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    alert(`✅ PDF exported successfully!\n\n${captured} sections captured on separate pages.\nText should be readable at 100% zoom!`);

                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                } catch (error) {
                    console.error('PDF export error:', error);
                    alert('❌ Failed to export PDF: ' + error.message);
                    
                    const exportBtn = event.target;
                    exportBtn.innerHTML = '<i class="bi bi-file-pdf"></i> Export to PDF';
                    exportBtn.disabled = false;
                }
                </text>
            }
            else
            {
                <text>
                alert('Please generate a horoscope first.');
                </text>
            }
        }

        // Function to capture HTML element as base64 PNG image
        async function captureElementAsBase64(element) {
            return new Promise((resolve, reject) => {
                try {
                    // Use html2canvas to capture the element
                    html2canvas(element, {
                        backgroundColor: '#FFFDE9',
                        scale: 2, // Higher resolution
                        logging: false
                    }).then(canvas => {
                        // Convert canvas to base64
                        const base64Image = canvas.toDataURL('image/png');
                        resolve(base64Image);
                    }).catch(error => {
                        console.error('html2canvas error:', error);
                        reject(error);
                    });
                } catch (error) {
                    console.error('Capture error:', error);
                    reject(error);
                }
            });
        }

        // ==============================================
        // SECURITY: Form Submission Protection
        // ==============================================
        (function() {
            'use strict';
            
            const form = document.getElementById('horoscopeForm');
            if (!form) return;

            // Store token generation state in window object for access by resetFormForNext()
            window.tokenGenerationState = {
                isTokensGenerated: false
            };

            // Monitor language change to reset token generation
            const languageSelect = document.querySelector('select[name="Language"]');
            if (languageSelect) {
                languageSelect.addEventListener('change', function() {
                    // Reset token generation when language changes
                    window.tokenGenerationState.isTokensGenerated = false;
                    document.getElementById('requestToken').value = '';
                    document.getElementById('requestTimestamp').value = '';
                    document.getElementById('birthDetailsChecksum').value = '';
                });
            }

            // Generate secure token before form submission
            form.addEventListener('submit', async function(e) {
                // Prevent default submission until tokens are generated
                if (!window.tokenGenerationState.isTokensGenerated) {
                    e.preventDefault();
                    
                    try {
                        // Get user ID from session (rendered server-side)
                        const userId = @(User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier) ?? "0");
                        
                        // Generate timestamp in yyyyMMddHHmmss format to match C# server
                        const now = new Date();
                        const year = now.getUTCFullYear();
                        const month = String(now.getUTCMonth() + 1).padStart(2, '0');
                        const day = String(now.getUTCDate()).padStart(2, '0');
                        const hour = String(now.getUTCHours()).padStart(2, '0');
                        const minute = String(now.getUTCMinutes()).padStart(2, '0');
                        const second = String(now.getUTCSeconds()).padStart(2, '0');
                        const timestamp = `${year}${month}${day}${hour}${minute}${second}`;
                        
                        // Store ISO format for server parsing
                        document.getElementById('requestTimestamp').value = now.toISOString();
                        
                        // Generate request token (client-side hash - validated server-side)
                        const tokenData = `${userId}|${timestamp}`;
                        const requestToken = await generateSecureHash(tokenData);
                        document.getElementById('requestToken').value = requestToken;
                        
                        // Generate birth details checksum
                        const personName = document.querySelector('input[name="PersonName"]').value;
                        const birthDate = document.querySelector('input[name="BirthDate"]').value;
                        const birthTime = document.querySelector('input[name="BirthTime"]').value;
                        const latitude = document.querySelector('input[name="Latitude"]').value;
                        const longitude = document.querySelector('input[name="Longitude"]').value;
                        const timezone = document.querySelector('select[name="TimeZoneOffset"]').value;
                        const placeName = document.querySelector('input[name="PlaceName"]').value;
                        
                        const checksumData = `${personName}|${birthDate}|${birthTime}|${latitude}|${longitude}|${timezone}|${placeName}`;
                        const checksum = await generateSecureHash(checksumData);
                        document.getElementById('birthDetailsChecksum').value = checksum;
                        
                        // Mark tokens as generated and resubmit form
                        window.tokenGenerationState.isTokensGenerated = true;
                        form.submit();
                        
                    } catch (error) {
                        console.error('[Security] Token generation failed:', error);
                        alert('Error generating security tokens. Please try again.');
                        // Reset token generation state on error
                        window.tokenGenerationState.isTokensGenerated = false;
                    }
                }
            });

            // Generate secure hash using Web Crypto API
            async function generateSecureHash(data) {
                const encoder = new TextEncoder();
                const dataBuffer = encoder.encode(data);
                const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            }

            // Prevent form field tampering detection
            const formFields = form.querySelectorAll('input, select, textarea');
            const originalValues = new Map();
            
            formFields.forEach(field => {
                if (field.type !== 'hidden' && field.name) {
                    originalValues.set(field.name, field.value);
                }
            });

            // Monitor for suspicious activity
            let tamperAttempts = 0;
            const maxTamperAttempts = 5;

            formFields.forEach(field => {
                if (field.type === 'hidden' && field.name.includes('Token')) {
                    // Protect security tokens from tampering
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                                tamperAttempts++;
                                if (tamperAttempts >= maxTamperAttempts) {
                                    alert('Security violation detected. This incident has been logged.');
                                    window.location.href = '/Account/Logout';
                                }
                            }
                        });
                    });
                    
                    observer.observe(field, { attributes: true });
                }
            });

            // Disable right-click on form (optional - can be removed if too restrictive)
            form.addEventListener('contextmenu', function(e) {
                // Allow right-click but log suspicious activity
                console.log('Context menu accessed on form');
            });

            // Disable F12 developer tools warning (informational only)
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                    // Just log, don't prevent (too intrusive to block entirely)
                    console.log('Developer tools access detected');
                }
            });

        })();

        // ==============================================
        // END SECURITY SECTION
        // ==============================================
    </script>
}
