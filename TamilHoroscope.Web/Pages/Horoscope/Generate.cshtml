@page
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@attribute [Authorize]
@inject TamilHoroscope.Web.Services.Interfaces.ISubscriptionService SubscriptionService
@inject TamilHoroscope.Web.Services.Interfaces.IWalletService WalletService
@inject TamilHoroscope.Web.Services.Interfaces.IConfigService ConfigService
@model TamilHoroscope.Web.Pages.Horoscope.GenerateModel
@{
    ViewData["Title"] = "Generate Horoscope";
    var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
    var isInTrial = await SubscriptionService.IsUserInTrialAsync(userId);
    var balance = await WalletService.GetBalanceAsync(userId);
    var perDayCost = await ConfigService.GetPerDayCostAsync();
}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-stars"></i> Generate Horoscope</h4>
            </div>
            <div class="card-body">
                @if (isInTrial)
                {
                    <div class="alert alert-info">
                        <i class="bi bi-gift"></i> <strong>Trial Period Active</strong>
                        <p class="mb-0">You're in trial period. Limited features available (no Navamsa chart, basic Dasa only). No charges will be applied.</p>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-wallet2"></i> <strong>Paid Service</strong>
                        <p class="mb-0">First horoscope generation of the day costs ₹@perDayCost.ToString("F2"). Current balance: ₹@balance.ToString("F2")</p>
                    </div>
                }

                <form method="post">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                    <h5 class="mt-3">Personal Information</h5>
                    <hr>

                    <div class="mb-3">
                        <label asp-for="PersonName" class="form-label"></label>
                        <input asp-for="PersonName" class="form-control" placeholder="Enter person's name" />
                        <span asp-validation-for="PersonName" class="text-danger"></span>
                    </div>

                    <h5 class="mt-3">Birth Information</h5>
                    <hr>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="BirthDate" class="form-label"></label>
                            <input asp-for="BirthDate" class="form-control" type="date" />
                            <span asp-validation-for="BirthDate" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="BirthTime" class="form-label"></label>
                            <input asp-for="BirthTime" class="form-control" type="time" />
                            <span asp-validation-for="BirthTime" class="text-danger"></span>
                        </div>
                    </div>

                    <h5 class="mt-3">Birth Location</h5>
                    <hr>

                    <div class="mb-3">
                        <label asp-for="PlaceName" class="form-label"></label>
                        <input asp-for="PlaceName" 
                               id="placeNameInput"
                               class="form-control" 
                               placeholder="Type to search cities..."
                               autocomplete="off"
                               list="citiesList" />
                        <datalist id="citiesList">
                            <!-- Datalist will be populated by JavaScript -->
                        </datalist>
                        <div id="placeDropdown" class="dropdown-menu" style="max-height: 300px; overflow-y: auto; width: 100%;"></div>
                        <span asp-validation-for="PlaceName" class="text-danger"></span>
                        <small class="form-text text-muted">Start typing to see suggestions</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Latitude" class="form-label"></label>
                            <input asp-for="Latitude" class="form-control" placeholder="e.g., 13.0827" step="0.000001" />
                            <span asp-validation-for="Latitude" class="text-danger"></span>
                            <small class="form-text text-muted">North: positive, South: negative</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Longitude" class="form-label"></label>
                            <input asp-for="Longitude" class="form-control" placeholder="e.g., 80.2707" step="0.000001" />
                            <span asp-validation-for="Longitude" class="text-danger"></span>
                            <small class="form-text text-muted">East: positive, West: negative</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="TimeZoneOffset" class="form-label"></label>
                        <select asp-for="TimeZoneOffset" class="form-select">
                            <option value="5.5">India Standard Time (UTC +5:30)</option>
                            <option value="5.75">Nepal Time (UTC +5:45)</option>
                            <option value="6">Bangladesh Time (UTC +6:00)</option>
                            <option value="8">Singapore Time (UTC +8:00)</option>
                            <option value="0">UTC (Greenwich Mean Time)</option>
                        </select>
                        <span asp-validation-for="TimeZoneOffset" class="text-danger"></span>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">
                        <i class="bi bi-stars"></i> Generate Horoscope
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Major Indian Cities</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>City</th>
                            <th>Lat</th>
                            <th>Lon</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr onclick="setLocation('Chennai', 13.0827, 80.2707)" style="cursor:pointer">
                            <td>Chennai</td>
                            <td>13.08</td>
                            <td>80.27</td>
                        </tr>
                        <tr onclick="setLocation('Mumbai', 19.0760, 72.8777)" style="cursor:pointer">
                            <td>Mumbai</td>
                            <td>19.08</td>
                            <td>72.88</td>
                        </tr>
                        <tr onclick="setLocation('Delhi', 28.7041, 77.1025)" style="cursor:pointer">
                            <td>Delhi</td>
                            <td>28.70</td>
                            <td>77.10</td>
                        </tr>
                        <tr onclick="setLocation('Bangalore', 12.9716, 77.5946)" style="cursor:pointer">
                            <td>Bangalore</td>
                            <td>12.97</td>
                            <td>77.59</td>
                        </tr>
                        <tr onclick="setLocation('Kolkata', 22.5726, 88.3639)" style="cursor:pointer">
                            <td>Kolkata</td>
                            <td>22.57</td>
                            <td>88.36</td>
                        </tr>
                    </tbody>
                </table>
                <small class="text-muted">Click a city to auto-fill location</small>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Features</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><i class="bi bi-check-circle text-success"></i> Birth chart (Rasi)</li>
                    <li><i class="bi bi-check-circle text-success"></i> Planetary positions</li>
                    <li><i class="bi bi-check-circle text-success"></i> Dasa periods</li>
                    @if (!isInTrial)
                    {
                        <li><i class="bi bi-check-circle text-success"></i> Navamsa chart (D-9)</li>
                        <li><i class="bi bi-check-circle text-success"></i> Bhukti sub-periods</li>
                        <li><i class="bi bi-check-circle text-success"></i> Planetary strength</li>
                    }
                    else
                    {
                        <li><i class="bi bi-x-circle text-muted"></i> <span class="text-muted">Navamsa chart (Paid only)</span></li>
                        <li><i class="bi bi-x-circle text-muted"></i> <span class="text-muted">Bhukti sub-periods (Paid only)</span></li>
                        <li><i class="bi bi-x-circle text-muted"></i> <span class="text-muted">Planetary strength (Paid only)</span></li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

@* Display Horoscope Results *@
@if (Model.Horoscope != null)
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="bi bi-stars"></i> Horoscope Results</h4>
                </div>
                <div class="card-body">
                    <h5>Birth Details</h5>
                    <table class="table table-bordered">
                        <tr>
                            <th>Name</th>
                            <td><strong>@Model.PersonName</strong></td>
                        </tr>
                        <tr>
                            <th>Date & Time</th>
                            <td>@Model.Horoscope.BirthDetails.DateTime.ToString("dddd, MMMM dd, yyyy HH:mm")</td>
                        </tr>
                        <tr>
                            <th>Place</th>
                            <td>@Model.Horoscope.BirthDetails.PlaceName</td>
                        </tr>
                        <tr>
                            <th>Coordinates</th>
                            <td>Latitude: @Model.Horoscope.BirthDetails.Latitude.ToString("F4")°, Longitude: @Model.Horoscope.BirthDetails.Longitude.ToString("F4")°</td>
                        </tr>
                        <tr>
                            <th>Lagna (Ascendant)</th>
                            <td><strong>@Model.Horoscope.LagnaRasiName (@Model.Horoscope.TamilLagnaRasiName)</strong></td>
                        </tr>
                    </table>

                    <h5 class="mt-4">Rasi Chart (Birth Chart) - ராசி கட்டம்</h5>
                    <div class="d-flex justify-content-center mb-4">
                        <div id="rasiChart" class="south-indian-chart">
                            <!-- Chart will be generated by JavaScript -->
                        </div>
                    </div>

                    <h5 class="mt-4">Planetary Positions</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Planet (கிரகம்)</th>
                                    <th>Rasi (ராசி)</th>
                                    <th>Nakshatra (நட்சத்திரம்)</th>
                                    <th>House</th>
                                    <th>Longitude</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var planet in Model.Horoscope.Planets)
                                {
                                    <tr>
                                        <td><strong>@planet.Name</strong> (@planet.TamilName)</td>
                                        <td>@planet.RasiName (@planet.TamilRasiName)</td>
                                        <td>@planet.NakshatraName (@planet.TamilNakshatraName)</td>
                                        <td>House @planet.House</td>
                                        <td>@planet.LongitudeFormatted</td>
                                        <td>
                                            @if (planet.IsRetrograde)
                                            {
                                                <span class="badge bg-warning">Retrograde</span>
                                            }
                                            @if (planet.IsCombust)
                                            {
                                                <span class="badge bg-danger">Combust</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (Model.Horoscope.VimshottariDasas != null && Model.Horoscope.VimshottariDasas.Any())
                    {
                        <h5 class="mt-4">Vimshottari Dasa Periods (விம்சோத்தரி தசை)</h5>
                        <div class="accordion" id="dasaAccordion">
                            @for (var i = 0; i < Math.Min(10, Model.Horoscope.VimshottariDasas.Count); i++)
                            {
                                var dasa = Model.Horoscope.VimshottariDasas[i];
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading@i">
                                        <button class="accordion-button @(i > 0 ? "collapsed" : "")" type="button" data-bs-toggle="collapse" data-bs-target="#collapse@i">
                                            <strong>@dasa.Lord (@dasa.TamilLord) Dasa</strong> &nbsp;-&nbsp; 
                                            @dasa.StartDate.ToString("MMM dd, yyyy") to @dasa.EndDate.ToString("MMM dd, yyyy")
                                        </button>
                                    </h2>
                                    <div id="collapse@i" class="accordion-collapse collapse @(i == 0 ? "show" : "")" data-bs-parent="#dasaAccordion">
                                        <div class="accordion-body">
                                            <p><strong>Duration:</strong> @((dasa.EndDate - dasa.StartDate).TotalDays / 365.25).ToString("F1") years</p>
                                            
                                            @if (!Model.IsTrialUser && dasa.Bhuktis != null && dasa.Bhuktis.Any())
                                            {
                                                <h6>Bhukti Sub-periods:</h6>
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>Bhukti</th>
                                                                <th>Start Date</th>
                                                                <th>End Date</th>
                                                                <th>Duration</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var bhukti in dasa.Bhuktis)
                                                            {
                                                                <tr>
                                                                    <td>@bhukti.Lord (@bhukti.TamilLord)</td>
                                                                    <td>@bhukti.StartDate.ToString("MMM dd, yyyy")</td>
                                                                    <td>@bhukti.EndDate.ToString("MMM dd, yyyy")</td>
                                                                    <td>@(bhukti.DurationDays / 365.25).ToString("F2") years</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            }
                                            else if (Model.IsTrialUser)
                                            {
                                                <div class="alert alert-info">
                                                    <i class="bi bi-lock"></i> Bhukti sub-periods are available in paid subscription only. <a asp-page="/Wallet/TopUp">Top up your wallet</a> to access full features.
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @if (!Model.IsTrialUser && Model.Horoscope.NavamsaPlanets != null && Model.Horoscope.NavamsaPlanets.Any())
                    {
                        <h5 class="mt-4">Navamsa Chart (D-9) - நவாம்ச கட்டம்</h5>
                        <div class="d-flex justify-content-center mb-3">
                            <div id="navamsaChart" class="south-indian-chart">
                                <!-- Chart will be generated by JavaScript -->
                            </div>
                        </div>

                        <h6 class="mt-3">Navamsa Planetary Positions</h6>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-secondary">
                                    <tr>
                                        <th>Planet</th>
                                        <th>Navamsa Rasi</th>
                                        <th>Longitude</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var planet in Model.Horoscope.NavamsaPlanets)
                                    {
                                        <tr>
                                            <td>@planet.Name (@planet.TamilName)</td>
                                            <td>@planet.RasiName (@planet.TamilRasiName)</td>
                                            <td>@planet.LongitudeFormatted</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else if (Model.IsTrialUser)
                    {
                        <div class="alert alert-warning mt-4">
                            <i class="bi bi-lock"></i> <strong>Navamsa Chart</strong> and <strong>Planetary Strength Analysis</strong> are available in paid subscription only. 
                            <a asp-page="/Wallet/TopUp" class="alert-link">Top up your wallet</a> to unlock all features.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger mt-4">
        <i class="bi bi-exclamation-triangle"></i> @Model.ErrorMessage
    </div>
}

@section Scripts {
<partial name="_ValidationScriptsPartial" />
    
<style>
    /* South Indian Style Rasi Chart */
    .south-indian-chart {
        width: 400px;
        height: 400px;
        display: grid;
        grid-template-columns: 100px 100px 100px 100px;
        grid-template-rows: 100px 100px 100px 100px;
        border: 2px solid #F88857;
        background: radial-gradient(circle, #FFFDE9, #FFFCD5);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .chart-box {
        border: 1px solid #F88857;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 5px;
        font-size: 11px;
        position: relative;
        background: #FFFDE9;
    }

    .chart-center {
        grid-column: 2 / 4;
        grid-row: 2 / 4;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        color: #800080;
        border: 1px solid #F88857;
    }

    .lagna-marker {
        background: #DC3545;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: bold;
        margin-bottom: 2px;
    }

    .planet-text {
        color: #800080;
        font-weight: 500;
        margin: 1px;
        font-size: 10px;
        display: inline-block;
    }

        .planets-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2px;
        }

        @@media (max-width: 576px) {
            .south-indian-chart {
                width: 320px;
                height: 320px;
                grid-template-columns: 80px 80px 80px 80px;
                grid-template-rows: 80px 80px 80px 80px;
            }
            .chart-box {
                font-size: 9px;
            }
            .planet-text {
                font-size: 8px;
            }
        }
    </style>

<script>
        // Comprehensive list of Indian and major world cities with coordinates
        const cities = [
            // Tamil Nadu
            { name: "Chennai, Tamil Nadu", lat: 13.0827, lon: 80.2707, tz: 5.5 },
            { name: "Coimbatore, Tamil Nadu", lat: 11.0168, lon: 76.9558, tz: 5.5 },
            { name: "Madurai, Tamil Nadu", lat: 9.9252, lon: 78.1198, tz: 5.5 },
            { name: "Trichy, Tamil Nadu", lat: 10.7905, lon: 78.7047, tz: 5.5 },
            { name: "Salem, Tamil Nadu", lat: 11.6643, lon: 78.1460, tz: 5.5 },
            { name: "Tirunelveli, Tamil Nadu", lat: 8.7139, lon: 77.7567, tz: 5.5 },
            { name: "Vellore, Tamil Nadu", lat: 12.9165, lon: 79.1325, tz: 5.5 },
            { name: "Erode, Tamil Nadu", lat: 11.3410, lon: 77.7172, tz: 5.5 },
            { name: "Tiruppur, Tamil Nadu", lat: 11.1085, lon: 77.3411, tz: 5.5 },
            { name: "Thoothukudi, Tamil Nadu", lat: 8.7642, lon: 78.1348, tz: 5.5 },
            { name: "Thanjavur, Tamil Nadu", lat: 10.7870, lon: 79.1378, tz: 5.5 },
            { name: "Dindigul, Tamil Nadu", lat: 10.3673, lon: 77.9803, tz: 5.5 },
            { name: "Ranipet, Tamil Nadu", lat: 12.9540, lon: 79.3326, tz: 5.5 },
            { name: "Sivakasi, Tamil Nadu", lat: 9.4524, lon: 77.8119, tz: 5.5 },
            { name: "Karur, Tamil Nadu", lat: 10.9601, lon: 78.0766, tz: 5.5 },
            { name: "Kanchipuram, Tamil Nadu", lat: 12.8342, lon: 79.7036, tz: 5.5 },
            { name: "Nagercoil, Tamil Nadu", lat: 8.1776, lon: 77.4342, tz: 5.5 },
            { name: "Kumbakonam, Tamil Nadu", lat: 10.9617, lon: 79.3881, tz: 5.5 },
            { name: "Tiruvallur, Tamil Nadu", lat: 13.1434, lon: 79.9077, tz: 5.5 },
            { name: "Kanyakumari, Tamil Nadu", lat: 8.0883, lon: 77.5385, tz: 5.5 },
            
            // Major Indian Cities
            { name: "Mumbai, Maharashtra", lat: 19.0760, lon: 72.8777, tz: 5.5 },
            { name: "Delhi", lat: 28.7041, lon: 77.1025, tz: 5.5 },
            { name: "Bangalore, Karnataka", lat: 12.9716, lon: 77.5946, tz: 5.5 },
            { name: "Hyderabad, Telangana", lat: 17.3850, lon: 78.4867, tz: 5.5 },
            { name: "Kolkata, West Bengal", lat: 22.5726, lon: 88.3639, tz: 5.5 },
            { name: "Pune, Maharashtra", lat: 18.5204, lon: 73.8567, tz: 5.5 },
            { name: "Ahmedabad, Gujarat", lat: 23.0225, lon: 72.5714, tz: 5.5 },
            { name: "Jaipur, Rajasthan", lat: 26.9124, lon: 75.7873, tz: 5.5 },
            { name: "Surat, Gujarat", lat: 21.1702, lon: 72.8311, tz: 5.5 },
            { name: "Lucknow, Uttar Pradesh", lat: 26.8467, lon: 80.9462, tz: 5.5 },
            { name: "Kanpur, Uttar Pradesh", lat: 26.4499, lon: 80.3319, tz: 5.5 },
            { name: "Nagpur, Maharashtra", lat: 21.1458, lon: 79.0882, tz: 5.5 },
            { name: "Indore, Madhya Pradesh", lat: 22.7196, lon: 75.8577, tz: 5.5 },
            { name: "Thane, Maharashtra", lat: 19.2183, lon: 72.9781, tz: 5.5 },
            { name: "Bhopal, Madhya Pradesh", lat: 23.2599, lon: 77.4126, tz: 5.5 },
            { name: "Visakhapatnam, Andhra Pradesh", lat: 17.6868, lon: 83.2185, tz: 5.5 },
            { name: "Pimpri-Chinchwad, Maharashtra", lat: 18.6298, lon: 73.7997, tz: 5.5 },
            { name: "Patna, Bihar", lat: 25.5941, lon: 85.1376, tz: 5.5 },
            { name: "Vadodara, Gujarat", lat: 22.3072, lon: 73.1812, tz: 5.5 },
            { name: "Ghaziabad, Uttar Pradesh", lat: 28.6692, lon: 77.4538, tz: 5.5 },
            { name: "Ludhiana, Punjab", lat: 30.9010, lon: 75.8573, tz: 5.5 },
            { name: "Agra, Uttar Pradesh", lat: 27.1767, lon: 78.0081, tz: 5.5 },
            { name: "Nashik, Maharashtra", lat: 19.9975, lon: 73.7898, tz: 5.5 },
            { name: "Faridabad, Haryana", lat: 28.4089, lon: 77.3178, tz: 5.5 },
            { name: "Meerut, Uttar Pradesh", lat: 28.9845, lon: 77.7064, tz: 5.5 },
            { name: "Rajkot, Gujarat", lat: 22.3039, lon: 70.8022, tz: 5.5 },
            { name: "Kalyan-Dombivli, Maharashtra", lat: 19.2403, lon: 73.1305, tz: 5.5 },
            { name: "Vasai-Virar, Maharashtra", lat: 19.4612, lon: 72.7985, tz: 5.5 },
            { name: "Varanasi, Uttar Pradesh", lat: 25.3176, lon: 82.9739, tz: 5.5 },
            { name: "Srinagar, Jammu and Kashmir", lat: 34.0837, lon: 74.7973, tz: 5.5 },
            { name: "Aurangabad, Maharashtra", lat: 19.8762, lon: 75.3433, tz: 5.5 },
            { name: "Dhanbad, Jharkhand", lat: 23.7957, lon: 86.4304, tz: 5.5 },
            { name: "Amritsar, Punjab", lat: 31.6340, lon: 74.8723, tz: 5.5 },
            { name: "Navi Mumbai, Maharashtra", lat: 19.0330, lon: 73.0297, tz: 5.5 },
            { name: "Allahabad (Prayagraj), Uttar Pradesh", lat: 25.4358, lon: 81.8463, tz: 5.5 },
            { name: "Ranchi, Jharkhand", lat: 23.3441, lon: 85.3096, tz: 5.5 },
            { name: "Howrah, West Bengal", lat: 22.5958, lon: 88.2636, tz: 5.5 },
            { name: "Jabalpur, Madhya Pradesh", lat: 23.1815, lon: 79.9864, tz: 5.5 },
            { name: "Gwalior, Madhya Pradesh", lat: 26.2183, lon: 78.1828, tz: 5.5 },
            { name: "Vijayawada, Andhra Pradesh", lat: 16.5062, lon: 80.6480, tz: 5.5 },
            { name: "Jodhpur, Rajasthan", lat: 26.2389, lon: 73.0243, tz: 5.5 },
            { name: "Raipur, Chhattisgarh", lat: 21.2514, lon: 81.6296, tz: 5.5 },
            { name: "Kota, Rajasthan", lat: 25.2138, lon: 75.8648, tz: 5.5 },
            
            // Kerala
            { name: "Thiruvananthapuram, Kerala", lat: 8.5241, lon: 76.9366, tz: 5.5 },
            { name: "Kochi, Kerala", lat: 9.9312, lon: 76.2673, tz: 5.5 },
            { name: "Kozhikode, Kerala", lat: 11.2588, lon: 75.7804, tz: 5.5 },
            { name: "Thrissur, Kerala", lat: 10.5276, lon: 76.2144, tz: 5.5 },
            { name: "Kollam, Kerala", lat: 8.8932, lon: 76.6141, tz: 5.5 },
            { name: "Kannur, Kerala", lat: 11.8745, lon: 75.3704, tz: 5.5 },
            { name: "Palakkad, Kerala", lat: 10.7867, lon: 76.6548, tz: 5.5 },
            
            // Karnataka
            { name: "Mysore, Karnataka", lat: 12.2958, lon: 76.6394, tz: 5.5 },
            { name: "Mangalore, Karnataka", lat: 12.9141, lon: 74.8560, tz: 5.5 },
            { name: "Hubli, Karnataka", lat: 15.3647, lon: 75.1240, tz: 5.5 },
            { name: "Belgaum, Karnataka", lat: 15.8497, lon: 74.4977, tz: 5.5 },
            
            // Andhra Pradesh & Telangana
            { name: "Tirupati, Andhra Pradesh", lat: 13.6288, lon: 79.4192, tz: 5.5 },
            { name: "Guntur, Andhra Pradesh", lat: 16.3067, lon: 80.4365, tz: 5.5 },
            { name: "Warangal, Telangana", lat: 17.9784, lon: 79.6004, tz: 5.5 },
            
            // International Cities
            { name: "New York, USA", lat: 40.7128, lon: -74.0060, tz: -5 },
            { name: "London, UK", lat: 51.5074, lon: -0.1278, tz: 0 },
            { name: "Paris, France", lat: 48.8566, lon: 2.3522, tz: 1 },
            { name: "Dubai, UAE", lat: 25.2048, lon: 55.2708, tz: 4 },
            { name: "Singapore", lat: 1.3521, lon: 103.8198, tz: 8 },
            { name: "Tokyo, Japan", lat: 35.6762, lon: 139.6503, tz: 9 },
            { name: "Sydney, Australia", lat: -33.8688, lon: 151.2093, tz: 10 },
            { name: "Toronto, Canada", lat: 43.6532, lon: -79.3832, tz: -5 },
            { name: "Los Angeles, USA", lat: 34.0522, lon: -118.2437, tz: -8 },
            { name: "Berlin, Germany", lat: 52.5200, lon: 13.4050, tz: 1 },
            { name: "Hong Kong", lat: 22.3193, lon: 114.1694, tz: 8 },
            { name: "Kuala Lumpur, Malaysia", lat: 3.1390, lon: 101.6869, tz: 8 },
            { name: "Bangkok, Thailand", lat: 13.7563, lon: 100.5018, tz: 7 },
            { name: "Shanghai, China", lat: 31.2304, lon: 121.4737, tz: 8 },
            { name: "Seoul, South Korea", lat: 37.5665, lon: 126.9780, tz: 9 }
        ];

        let selectedCityIndex = -1;

        // Initialize autocomplete
        document.addEventListener('DOMContentLoaded', function() {
            const placeInput = document.getElementById('placeNameInput');
            const dropdown = document.getElementById('placeDropdown');
            
            if (!placeInput || !dropdown) return;

            // Handle input changes
            placeInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase().trim();
                
                if (searchText.length === 0) {
                    dropdown.classList.remove('show');
                    dropdown.innerHTML = '';
                    return;
                }

                // Filter cities
                const matches = cities.filter(city => 
                    city.name.toLowerCase().includes(searchText)
                ).slice(0, 10); // Limit to 10 results

                if (matches.length === 0) {
                    dropdown.classList.remove('show');
                    dropdown.innerHTML = '';
                    return;
                }

                // Build dropdown HTML
                dropdown.innerHTML = matches.map((city, index) => 
                    `<a href="#" class="dropdown-item" data-index="${index}" data-city="${city.name}" data-lat="${city.lat}" data-lon="${city.lon}" data-tz="${city.tz}">
                        <i class="bi bi-geo-alt-fill text-primary me-2"></i>${city.name}
                    </a>`
                ).join('');

                dropdown.classList.add('show');
                selectedCityIndex = -1;
            });

            // Handle dropdown clicks
            dropdown.addEventListener('click', function(e) {
                e.preventDefault();
                const item = e.target.closest('.dropdown-item');
                if (!item) return;

                const cityName = item.dataset.city;
                const lat = parseFloat(item.dataset.lat);
                const lon = parseFloat(item.dataset.lon);
                const tz = parseFloat(item.dataset.tz);

                setLocationFromAutocomplete(cityName, lat, lon, tz);
                dropdown.classList.remove('show');
            });

            // Handle keyboard navigation
            placeInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.dropdown-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedCityIndex = Math.min(selectedCityIndex + 1, items.length - 1);
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedCityIndex = Math.max(selectedCityIndex - 1, 0);
                    updateSelection(items);
                } else if (e.key === 'Enter' && selectedCityIndex >= 0) {
                    e.preventDefault();
                    items[selectedCityIndex].click();
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!placeInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            function updateSelection(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('active', index === selectedCityIndex);
                });
                if (selectedCityIndex >= 0) {
                    items[selectedCityIndex].scrollIntoView({ block: 'nearest' });
                }
            }
        });

        function setLocationFromAutocomplete(place, lat, lon, tz) {
            const placeInput = document.querySelector('input[name="PlaceName"]');
            const latInput = document.querySelector('input[name="Latitude"]');
            const lonInput = document.querySelector('input[name="Longitude"]');
            const tzSelect = document.querySelector('select[name="TimeZoneOffset"]');
            
            if (placeInput) placeInput.value = place;
            if (latInput) latInput.value = lat.toFixed(6);
            if (lonInput) lonInput.value = lon.toFixed(6);
            
            // Set timezone or default to IST
            if (tzSelect) {
                // Find the closest timezone option
                const options = Array.from(tzSelect.options);
                const closestOption = options.reduce((prev, curr) => {
                    return Math.abs(parseFloat(curr.value) - tz) < Math.abs(parseFloat(prev.value) - tz) ? curr : prev;
                });
                tzSelect.value = closestOption.value;
            }
            
            // Visual feedback
            highlightField(placeInput);
            highlightField(latInput);
            highlightField(lonInput);
        }

        function setLocation(place, lat, lon) {
            setLocationFromAutocomplete(place, lat, lon, 5.5);
        }

        function highlightField(field) {
            if (!field) return;
            field.classList.add('bg-warning', 'bg-opacity-25');
            setTimeout(() => {
                field.classList.remove('bg-warning', 'bg-opacity-25');
            }, 1000);
        }

        // Rasi Chart Drawing Function
        function drawRasiChart(horoscopeData) {
            drawChart(horoscopeData, 'rasiChart', horoscopeData.Planets, horoscopeData.LagnaRasi, 'ராசி');
        }

        // Navamsa Chart Drawing Function
        function drawNavamsaChart(horoscopeData) {
            if (horoscopeData.NavamsaPlanets && horoscopeData.NavamsaPlanets.length > 0) {
                // For Navamsa, we don't show Lagna marker (or we can calculate Navamsa Lagna if available)
                drawChart(horoscopeData, 'navamsaChart', horoscopeData.NavamsaPlanets, null, 'நவாம்சம்');
            }
        }

        // Generic chart drawing function for both Rasi and Navamsa
        function drawChart(horoscopeData, containerId, planetsData, lagnaRasi, title) {
            const chartContainer = document.getElementById(containerId);
            if (!chartContainer || !horoscopeData) return;

            // Clear existing content
            chartContainer.innerHTML = '';

            // Planet abbreviations in Tamil
            const planetAbbrev = {
                'Sun': 'சூரி',
                'Moon': 'சந்',
                'Mars': 'செவ்',
                'Mercury': 'புத',
                'Jupiter': 'குரு',
                'Venus': 'சுக்',
                'Saturn': 'சனி',
                'Rahu': 'ராகு',
                'Ketu': 'கேது'
            };

            // Group planets by Rasi
            const rasiToPlanets = {};
            for (let i = 1; i <= 12; i++) {
                rasiToPlanets[i] = [];
            }

            planetsData.forEach(planet => {
                const abbrev = planetAbbrev[planet.Name] || planet.Name.substring(0, 2);
                rasiToPlanets[planet.Rasi].push(abbrev);
            });

            // South Indian chart positions (4x4 grid)
            // Layout: 12  1   2   3
            //         11 [CENTER] 4
            //         10 [CENTER] 5
            //          9  8   7   6
            const boxPositions = [
                { gridRow: 1, gridCol: 1, rasi: 12 },  // Pisces
                { gridRow: 1, gridCol: 2, rasi: 1 },   // Aries
                { gridRow: 1, gridCol: 3, rasi: 2 },   // Taurus
                { gridRow: 1, gridCol: 4, rasi: 3 },   // Gemini
                { gridRow: 2, gridCol: 4, rasi: 4 },   // Cancer
                { gridRow: 3, gridCol: 4, rasi: 5 },   // Leo
                { gridRow: 4, gridCol: 4, rasi: 6 },   // Virgo
                { gridRow: 4, gridCol: 3, rasi: 7 },   // Libra
                { gridRow: 4, gridCol: 2, rasi: 8 },   // Scorpio
                { gridRow: 4, gridCol: 1, rasi: 9 },   // Sagittarius
                { gridRow: 3, gridCol: 1, rasi: 10 },  // Capricorn
                { gridRow: 2, gridCol: 1, rasi: 11 }   // Aquarius
            ];

            // Create all 12 boxes
            boxPositions.forEach(pos => {
                const box = document.createElement('div');
                box.className = 'chart-box';
                box.style.gridRow = pos.gridRow;
                box.style.gridColumn = pos.gridCol;

                // Add Lagna marker if this is the Lagna rasi
                if (lagnaRasi && pos.rasi === lagnaRasi) {
                    const lagnaMarker = document.createElement('div');
                    lagnaMarker.className = 'lagna-marker';
                    lagnaMarker.textContent = 'லக்';  // Tamil "Lak" for Lagna
                    box.appendChild(lagnaMarker);
                }

                // Add planets in this rasi
                const planets = rasiToPlanets[pos.rasi];
                if (planets.length > 0) {
                    const planetsContainer = document.createElement('div');
                    planetsContainer.className = 'planets-container';
                    planets.forEach(planetAbbrev => {
                        const planetSpan = document.createElement('span');
                        planetSpan.className = 'planet-text';
                        planetSpan.textContent = planetAbbrev;
                        planetsContainer.appendChild(planetSpan);
                    });
                    box.appendChild(planetsContainer);
                }

                chartContainer.appendChild(box);
            });

            // Add center title
            const centerBox = document.createElement('div');
            centerBox.className = 'chart-center';
            centerBox.textContent = title;
            chartContainer.appendChild(centerBox);
        }

        // Auto-draw charts if horoscope data exists on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we have horoscope data in the page (from Model.Horoscope)
            @if (Model.Horoscope != null)
            {
                <text>
                const horoscopeData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Horoscope));
                
                // Draw Rasi chart (always shown)
                drawRasiChart(horoscopeData);
                
                // Draw Navamsa chart (only for paid users)
                @if (!Model.IsTrialUser)
                {
                    <text>
                    drawNavamsaChart(horoscopeData);
                    </text>
                }
                </text>
            }
        });
    </script>
}
