@page
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@attribute [Authorize]
@inject TamilHoroscope.Web.Services.Interfaces.ISubscriptionService SubscriptionService
@inject TamilHoroscope.Web.Services.Interfaces.IWalletService WalletService
@inject TamilHoroscope.Web.Services.Interfaces.IConfigService ConfigService
@model TamilHoroscope.Web.Pages.Horoscope.GenerateModel
@{
    ViewData["Title"] = "Generate Horoscope";
    var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)!);
    var isInTrial = await SubscriptionService.IsUserInTrialAsync(userId);
    var balance = await WalletService.GetBalanceAsync(userId);
    var perDayCost = await ConfigService.GetPerDayCostAsync();
}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-stars"></i> Generate Horoscope</h4>
            </div>
            <div class="card-body">
                @if (isInTrial)
                {
                    <div class="alert alert-info">
                        <i class="bi bi-gift"></i> <strong>Trial Period Active</strong>
                        <p class="mb-0">You're in trial period. Limited features available (no Navamsa chart, basic Dasa only). No charges will be applied.</p>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-wallet2"></i> <strong>Paid Service</strong>
                        <p class="mb-0">First horoscope generation of the day costs ₹@perDayCost.ToString("F2"). Current balance: ₹@balance.ToString("F2")</p>
                    </div>
                }

                <form method="post">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                    <h5 class="mt-3">Birth Information</h5>
                    <hr>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="BirthDate" class="form-label"></label>
                            <input asp-for="BirthDate" class="form-control" type="date" />
                            <span asp-validation-for="BirthDate" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="BirthTime" class="form-label"></label>
                            <input asp-for="BirthTime" class="form-control" type="time" />
                            <span asp-validation-for="BirthTime" class="text-danger"></span>
                        </div>
                    </div>

                    <h5 class="mt-3">Birth Location</h5>
                    <hr>

                    <div class="mb-3">
                        <label asp-for="PlaceName" class="form-label"></label>
                        <input asp-for="PlaceName" class="form-control" placeholder="e.g., Chennai, Tamil Nadu" />
                        <span asp-validation-for="PlaceName" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Latitude" class="form-label"></label>
                            <input asp-for="Latitude" class="form-control" placeholder="e.g., 13.0827" step="0.000001" />
                            <span asp-validation-for="Latitude" class="text-danger"></span>
                            <small class="form-text text-muted">North: positive, South: negative</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Longitude" class="form-label"></label>
                            <input asp-for="Longitude" class="form-control" placeholder="e.g., 80.2707" step="0.000001" />
                            <span asp-validation-for="Longitude" class="text-danger"></span>
                            <small class="form-text text-muted">East: positive, West: negative</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="TimeZoneOffset" class="form-label"></label>
                        <select asp-for="TimeZoneOffset" class="form-select">
                            <option value="5.5">India Standard Time (UTC +5:30)</option>
                            <option value="5.75">Nepal Time (UTC +5:45)</option>
                            <option value="6">Bangladesh Time (UTC +6:00)</option>
                            <option value="8">Singapore Time (UTC +8:00)</option>
                            <option value="0">UTC (Greenwich Mean Time)</option>
                        </select>
                        <span asp-validation-for="TimeZoneOffset" class="text-danger"></span>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">
                        <i class="bi bi-stars"></i> Generate Horoscope
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Major Indian Cities</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>City</th>
                            <th>Lat</th>
                            <th>Lon</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr onclick="setLocation('Chennai', 13.0827, 80.2707)" style="cursor:pointer">
                            <td>Chennai</td>
                            <td>13.08</td>
                            <td>80.27</td>
                        </tr>
                        <tr onclick="setLocation('Mumbai', 19.0760, 72.8777)" style="cursor:pointer">
                            <td>Mumbai</td>
                            <td>19.08</td>
                            <td>72.88</td>
                        </tr>
                        <tr onclick="setLocation('Delhi', 28.7041, 77.1025)" style="cursor:pointer">
                            <td>Delhi</td>
                            <td>28.70</td>
                            <td>77.10</td>
                        </tr>
                        <tr onclick="setLocation('Bangalore', 12.9716, 77.5946)" style="cursor:pointer">
                            <td>Bangalore</td>
                            <td>12.97</td>
                            <td>77.59</td>
                        </tr>
                        <tr onclick="setLocation('Kolkata', 22.5726, 88.3639)" style="cursor:pointer">
                            <td>Kolkata</td>
                            <td>22.57</td>
                            <td>88.36</td>
                        </tr>
                    </tbody>
                </table>
                <small class="text-muted">Click a city to auto-fill location</small>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Features</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><i class="bi bi-check-circle text-success"></i> Birth chart (Rasi)</li>
                    <li><i class="bi bi-check-circle text-success"></i> Planetary positions</li>
                    <li><i class="bi bi-check-circle text-success"></i> Dasa periods</li>
                    @if (!isInTrial)
                    {
                        <li><i class="bi bi-check-circle text-success"></i> Navamsa chart (D-9)</li>
                        <li><i class="bi bi-check-circle text-success"></i> Bhukti sub-periods</li>
                        <li><i class="bi bi-check-circle text-success"></i> Planetary strength</li>
                    }
                    else
                    {
                        <li><i class="bi bi-x-circle text-muted"></i> <span class="text-muted">Navamsa chart (Paid only)</span></li>
                        <li><i class="bi bi-x-circle text-muted"></i> <span class="text-muted">Bhukti sub-periods (Paid only)</span></li>
                        <li><i class="bi bi-x-circle text-muted"></i> <span class="text-muted">Planetary strength (Paid only)</span></li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

@* Display Horoscope Results *@
@if (Model.Horoscope != null)
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="bi bi-stars"></i> Horoscope Results</h4>
                </div>
                <div class="card-body">
                    <h5>Birth Details</h5>
                    <table class="table table-bordered">
                        <tr>
                            <th>Date & Time</th>
                            <td>@Model.Horoscope.BirthDetails.DateTime.ToString("dddd, MMMM dd, yyyy HH:mm")</td>
                        </tr>
                        <tr>
                            <th>Place</th>
                            <td>@Model.Horoscope.BirthDetails.PlaceName</td>
                        </tr>
                        <tr>
                            <th>Coordinates</th>
                            <td>Latitude: @Model.Horoscope.BirthDetails.Latitude.ToString("F4")°, Longitude: @Model.Horoscope.BirthDetails.Longitude.ToString("F4")°</td>
                        </tr>
                        <tr>
                            <th>Lagna (Ascendant)</th>
                            <td><strong>@Model.Horoscope.LagnaRasiName (@Model.Horoscope.TamilLagnaRasiName)</strong></td>
                        </tr>
                    </table>

                    <h5 class="mt-4">Planetary Positions</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Planet (கிரகம்)</th>
                                    <th>Rasi (ராசி)</th>
                                    <th>Nakshatra (நட்சத்திரம்)</th>
                                    <th>House</th>
                                    <th>Longitude</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var planet in Model.Horoscope.Planets)
                                {
                                    <tr>
                                        <td><strong>@planet.Name</strong> (@planet.TamilName)</td>
                                        <td>@planet.RasiName (@planet.TamilRasiName)</td>
                                        <td>@planet.NakshatraName (@planet.TamilNakshatraName)</td>
                                        <td>House @planet.House</td>
                                        <td>@planet.LongitudeFormatted</td>
                                        <td>
                                            @if (planet.IsRetrograde)
                                            {
                                                <span class="badge bg-warning">Retrograde</span>
                                            }
                                            @if (planet.IsCombust)
                                            {
                                                <span class="badge bg-danger">Combust</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (Model.Horoscope.VimshottariDasas != null && Model.Horoscope.VimshottariDasas.Any())
                    {
                        <h5 class="mt-4">Vimshottari Dasa Periods (விம்சோத்தரி தசை)</h5>
                        <div class="accordion" id="dasaAccordion">
                            @for (var i = 0; i < Math.Min(10, Model.Horoscope.VimshottariDasas.Count); i++)
                            {
                                var dasa = Model.Horoscope.VimshottariDasas[i];
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading@i">
                                        <button class="accordion-button @(i > 0 ? "collapsed" : "")" type="button" data-bs-toggle="collapse" data-bs-target="#collapse@i">
                                            <strong>@dasa.Lord (@dasa.TamilLord) Dasa</strong> &nbsp;-&nbsp; 
                                            @dasa.StartDate.ToString("MMM dd, yyyy") to @dasa.EndDate.ToString("MMM dd, yyyy")
                                        </button>
                                    </h2>
                                    <div id="collapse@i" class="accordion-collapse collapse @(i == 0 ? "show" : "")" data-bs-parent="#dasaAccordion">
                                        <div class="accordion-body">
                                            <p><strong>Duration:</strong> @((dasa.EndDate - dasa.StartDate).TotalDays / 365.25).ToString("F1") years</p>
                                            
                                            @if (!Model.IsTrialUser && dasa.Bhuktis != null && dasa.Bhuktis.Any())
                                            {
                                                <h6>Bhukti Sub-periods:</h6>
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>Bhukti</th>
                                                                <th>Start Date</th>
                                                                <th>End Date</th>
                                                                <th>Duration</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var bhukti in dasa.Bhuktis)
                                                            {
                                                                <tr>
                                                                    <td>@bhukti.Lord (@bhukti.TamilLord)</td>
                                                                    <td>@bhukti.StartDate.ToString("MMM dd, yyyy")</td>
                                                                    <td>@bhukti.EndDate.ToString("MMM dd, yyyy")</td>
                                                                    <td>@(bhukti.DurationDays / 365.25).ToString("F2") years</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            }
                                            else if (Model.IsTrialUser)
                                            {
                                                <div class="alert alert-info">
                                                    <i class="bi bi-lock"></i> Bhukti sub-periods are available in paid subscription only. <a asp-page="/Wallet/TopUp">Top up your wallet</a> to access full features.
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @if (!Model.IsTrialUser && Model.Horoscope.NavamsaPlanets != null && Model.Horoscope.NavamsaPlanets.Any())
                    {
                        <h5 class="mt-4">Navamsa Chart (D-9) - நவாம்ச குறிப்பு</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-secondary">
                                    <tr>
                                        <th>Planet</th>
                                        <th>Navamsa Rasi</th>
                                        <th>Longitude</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var planet in Model.Horoscope.NavamsaPlanets)
                                    {
                                        <tr>
                                            <td>@planet.Name (@planet.TamilName)</td>
                                            <td>@planet.RasiName (@planet.TamilRasiName)</td>
                                            <td>@planet.LongitudeFormatted</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else if (Model.IsTrialUser)
                    {
                        <div class="alert alert-warning mt-4">
                            <i class="bi bi-lock"></i> <strong>Navamsa Chart</strong> and <strong>Planetary Strength Analysis</strong> are available in paid subscription only. 
                            <a asp-page="/Wallet/TopUp" class="alert-link">Top up your wallet</a> to unlock all features.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger mt-4">
        <i class="bi bi-exclamation-triangle"></i> @Model.ErrorMessage
    </div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function setLocation(place, lat, lon) {
            document.getElementById('PlaceName').value = place;
            document.getElementById('Latitude').value = lat;
            document.getElementById('Longitude').value = lon;
        }
    </script>
}
